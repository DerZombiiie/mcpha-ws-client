
function formatISODate(f){var i=new Date(f);var b=i.getDate();var h=i.getMonth()+1;var e=i.getFullYear();var a=i.getHours();var g=i.getMinutes();var c=i.getSeconds();if(b<10){b="0"+b}if(h<10){h="0"+h}if(a<10){a="0"+a}if(g<10){g="0"+g}if(c<10){c="0"+c}return e+"-"+h+"-"+b+"T"+a+":"+g+":"+c+"Z"}function uint_8_to_base_64(b){var e=32768;var c=0;var d=b.length;var a="";var f;while(c<d){f=b.subarray(c,Math.min(c+e,d));a+=String.fromCharCode.apply(null,f);c+=e}return btoa(a)}function string_to_uint(b){var b=btoa(unescape(encodeURIComponent(b))),a=b.split(""),d=[];for(var c=0;c<a.length;c++){d.push(a[c].charCodeAt(0))}return new Uint8Array(d)}function dump_mca_data(g,b,h,d,a,f,e,c){if(h==="ortec-chn"){return dump_mca_data_ortec_chn(g,b,d,a,f,e,c)}else{if(h==="plain-txt"){return dump_mca_data_plain_text(g,b,d,a,f,e,c)}else{if(h==="json-txt"){return dump_mca_data_json_text(g,b,d,a,f,e,c)}}}}function dump_mca_data_json_text(e,l,g,f,h,k,a){var m={};var j=[];for(var c=0;c<e.length;c++){j.push(e[c][1])}m.data=j;m.nchannels=e.length;m.mca=g;m.acqdate=formatISODate(f);m.sample=h;m.detector=k;m.roi=[{count:l[0].count},{count:l[1].count},{count:l[2].count}];var b={file:a+".json",payload:"data:text/json,"+JSON.stringify(m)};return b}function dump_mca_data_plain_text(e,k,g,f,h,j,a){var b="data:text/plain,# MCA #"+g+" with "+e.length+" channels%0D# Acquisition date%0D"+formatISODate(f)+"%0D# Sample description%0D"+h+"%0D# Detector description%0D"+j+"%0D# ROI data%0D"+k[0].count+"%0D"+k[1].count+"%0D"+k[2].count+"%0D# Channel data";for(var d=0;d<e.length;d++){b+="%0D"+e[d][1]}var c={file:a+".txt",payload:b};return c}function dump_mca_data_ortec_chn(e,n,g,f,h,m,a){var b=new ArrayBuffer(512+32+(e.length*4));var l=new DataView(b);l.setInt16(0,-1,true);l.setInt16(2,g,true);l.setInt16(4,0,true);l.setUint8(6,48);l.setUint8(7,52);l.setUint32(8,16022,true);l.setUint32(12,15000,true);l.setUint8(16,49);l.setUint8(17,54);l.setUint8(18,65);l.setUint8(19,112);l.setUint8(20,114);l.setUint8(21,48);l.setUint8(22,57);l.setUint8(23,49);l.setUint8(24,49);l.setUint8(25,51);l.setUint8(26,51);l.setUint8(27,55);l.setUint16(28,0,true);l.setUint16(30,e.length,true);var k=32;for(var d=0;d<e.length;d++){l.setUint32(k,e[d][1],true);k+=4}var j=32+(e.length*4);l.setUint16(j,-102,true);l.setUint8(j+256,m.length);for(var d=0;d<m.length&&d<63;d++){l.setUint8(j+257+d,m.charCodeAt(d))}l.setUint8(j+320,h.length);for(var d=0;d<h.length&&d<63;d++){l.setUint8(j+321+d,h.charCodeAt(d))}var c={file:a+".chn",payload:"data:application/octet-stream;base64,"+uint_8_to_base_64(new Uint8Array(b))};return c};