
function show_busy_indicator(a){if(a){$("body").removeClass("loaded")}else{$("body").addClass("loaded")}}function debounce(b,d,a){var c;return function(){var h=this,g=arguments;var f=function(){c=null;if(!a){b.apply(h,g)}};var e=a&&!c;clearTimeout(c);c=setTimeout(f,d);if(e){b.apply(h,g)}}}function default_mca_chart_options(){return{lines:{show:true,steps:true},points:{show:false},axisLabels:{show:true},xaxes:[{axisLabel:"Channel"}],yaxes:[{position:"right",axisLabel:"Counts"}],xaxis:{panRange:false,tickDecimals:0,tickSize:2000,min:0,max:16384,transform:function(a){return a}},yaxis:{panRange:false,labelWidth:140,reserveSpace:true,position:"right",max:100,min:0,ticks:null,transform:null},grid:{backgroundColor:"#999",hoverable:true,clickable:true,autoHighlight:false},crosshair:{mode:"x"},zoom:{interactive:true},pan:{interactive:false},selection:{mode:null}}}function default_osc_chart_options(){return{lines:{show:true,steps:true},points:{show:false},axisLabels:{show:true},xaxes:[{axisLabel:"Time (&#181;s)"}],yaxes:[{position:"right",axisLabel:"Volts"}],xaxis:{panRange:false,tickDecimals:0,transform:function(a){return a}},yaxis:{range_index:0,panRange:false,labelWidth:140,reserveSpace:true,position:"right",ticks:null,transform:null},grid:{backgroundColor:"#999",hoverable:true,clickable:true,autoHighlight:false},crosshair:{mode:"x"},zoom:{interactive:true},pan:{interactive:false},selection:{mode:null}}}function mcpha_send(c,f,e,b){if(wsock!==null){var a=new ArrayBuffer(16);var d=new Uint32Array(a);var g=new Float64Array(a,8);d[0]=c;d[1]=f;g[0]=e;wsock.send(a,{binary:true});if(c===MCPHA_COMMAND_SET_TIMER_MODE&&e===1){acqdat[f]=Date.now();log_status_message("Starting acquisition at "+formatISODate(acqdat[f]),true)}}}function init_device_state(){mcpha_send(MCPHA_COMMAND_SET_SAMPLE_RATE,0,4);mcpha_send(MCPHA_COMMAND_SET_PHA_DELAY,0,100);mcpha_send(MCPHA_COMMAND_SET_PHA_MIN_THRESHOLD,0,parseInt(localStorage.getItem(MCPHA_MCA_LLD)));mcpha_send(MCPHA_COMMAND_SET_PHA_MAX_THRESHOLD,0,parseInt(localStorage.getItem(MCPHA_MCA_ULD)));mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE,0,localStorage.getItem(MCPHA_MCA_1_IN_NEG)===" true"?1:0);mcpha_send(MCPHA_COMMAND_GET_TIMER,0,0);mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA,0,0);mcpha_send(MCPHA_COMMAND_SET_PHA_MIN_THRESHOLD,1,parseInt(localStorage.getItem(MCPHA_MCA_LLD)));mcpha_send(MCPHA_COMMAND_SET_PHA_MAX_THRESHOLD,1,parseInt(localStorage.getItem(MCPHA_MCA_ULD)));mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE,1,localStorage.getItem(MCPHA_MCA_2_IN_NEG)===" true"?1:0);mcpha_send(MCPHA_COMMAND_GET_TIMER,1,0);mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA,1,0);if(localStorage.getItem(MCPHA_OSC_TRIG_SOURCE)==="1"){mcpha_send(MCPHA_COMMAND_SET_TRIGGER_SOURCE,0,0)}else{mcpha_send(MCPHA_COMMAND_SET_TRIGGER_SOURCE,1,0)}if(localStorage.getItem(MCPHA_OSC_TRIG_MODE)==="n"){mcpha_send(MCPHA_COMMAND_SET_TRIGGER_MODE,0,0)}else{mcpha_send(MCPHA_COMMAND_SET_TRIGGER_MODE,1,0)}if(localStorage.getItem(MCPHA_OSC_TRIG_EDGE)==="r"){mcpha_send(MCPHA_COMMAND_SET_TRIGGER_SLOPE,0,0)}else{mcpha_send(MCPHA_COMMAND_SET_TRIGGER_SLOPE,1,0)}mcpha_send(MCPHA_COMMAND_SET_TRIGGER_LEVEL,0,parseInt(localStorage.getItem(MCPHA_OSC_TRIG_LEVEL)));mcpha_send(MCPHA_COMMAND_SET_NUMBER_OF_SAMPLES_BEFORE_TRIGGER,0,1000)}function log_status_message(b,a){if(a!=="undefined"&&a!==null&&a){Materialize.toast(b,TOAST_DELAY,"toast-css")}$("<span>"+b+"<span><br/>").appendTo("#messages")}function update_mca_acquisition_buttons_text(a){$("#enableacq").html(a?STOP_ACQUISITION_TEXT:START_ACQUISITION_TEXT);if(a){$("#net-traffic").addClass("infinite");$("#net-traffic").addClass("white-text")}else{$("#net-traffic").removeClass("infinite");$("#net-traffic").removeClass("white-text");log_status_message("Stopping mca acquisition",true)}}function update_toolbar_buttons(a){var b=localStorage.getItem(MCPHA_SELECTED_TAB);if(b===null||b.startsWith("mca")){if(a){$("#roi1").removeClass("disabled");$("#roi2").removeClass("disabled");$("#roi3").removeClass("disabled");$("#rois").removeClass("disabled");$("#enableacq").removeClass("disabled");$("#cleartimer").removeClass("disabled");$("#cleardata").removeClass("disabled");$("#fullextent").removeClass("disabled");$("#zoomin").removeClass("disabled");$("#zoomout").removeClass("disabled");$("#pan").removeClass("disabled");$("#linscale").removeClass("disabled");$("#logscale").removeClass("disabled");$("#download").removeClass("disabled")}else{$("#roi1").addClass("disabled");$("#roi2").addClass("disabled");$("#roi3").addClass("disabled");$("#rois").addClass("disabled");$("#enableacq").addClass("disabled");$("#cleartimer").addClass("disabled");$("#cleardata").addClass("disabled");$("#fullextent").addClass("disabled");$("#zoomin").addClass("disabled");$("#zoomout").addClass("disabled");$("#pan").addClass("disabled");$("#linscale").addClass("disabled");$("#logscale").addClass("disabled");$("#download").addClass("disabled")}}else{if(b==="log"){}else{if(b==="osc"){if(a){$("#getoscdata").removeClass("disabled")}else{$("#getoscdata").addClass("disabled")}}}}}function init_sidebar(){$("#mca-1-sidebar").css("display","none");$("#mca-2-sidebar").css("display","none");$("#osc-sidebar").css("display","none");$("#log-sidebar").css("display","none");$("#mca-1").on("click",function(){select_tab("mca-1")});$("#mca-2").on("click",function(){select_tab("mca-2")});$("#osc").on("click",function(){select_tab("osc")});$("#log").on("click",function(){select_tab("log")});var a=localStorage.getItem(MCPHA_SIDEBAR_OPEN);show_sidebar(a!==null)}function show_sidebar(a){if(a){$("#slide-menu").addClass("open-side-nav");$("#slide-body").addClass("open-body-nav")}else{$("#slide-menu").removeClass("open-side-nav");$("#slide-body").removeClass("open-body-nav")}}function devstatus_string(a){return(a===WEBSOCKET_DISCONNECTED)?"is disconnected":(a===WEBSOCKET_CONNECTING)?"is connecting":(a===WEBSOCKET_CONNECTED)?"is connected":(a===WEBSOCKET_ERROR)?"connection error":"unknown"}function select_tab(a){localStorage.setItem(MCPHA_SELECTED_TAB,a);if(a==="mca-1"||a===null){$("#mca-1-sidebar").css("display","inline");$("#mca-2-sidebar").css("display","none");$("#osc-sidebar").css("display","none");$("#log-sidebar").css("display","none");$("#mca-toolbar").css("display","inline");$("#osc-toolbar").css("display","none");$("#mca-container").css("display","inline");$("#osc-container").css("display","none");$("#log-container").css("display","none");$("#mca-1").addClass("selectedtab");$("#mca-2").removeClass("selectedtab");$("#osc").removeClass("selectedtab");$("#log").removeClass("selectedtab");$("#acqtime_s").text(localStorage.getItem(MCPHA_MCA_1_ACQ_TIME))}else{if(a==="mca-2"){$("#mca-1-sidebar").css("display","none");$("#mca-2-sidebar").css("display","inline");$("#osc-sidebar").css("display","none");$("#log-sidebar").css("display","none");$("#mca-toolbar").css("display","inline");$("#osc-toolbar").css("display","none");$("#mca-container").css("display","inline");$("#osc-container").css("display","none");$("#log-container").css("display","none");$("#mca-1").removeClass("selectedtab");$("#mca-2").addClass("selectedtab");$("#osc").removeClass("selectedtab");$("#log").removeClass("selectedtab");$("#acqtime_s").text(localStorage.getItem(MCPHA_MCA_2_ACQ_TIME))}else{if(a==="osc"){$("#mca-1-sidebar").css("display","none");$("#mca-2-sidebar").css("display","none");$("#osc-sidebar").css("display","inline");$("#log-sidebar").css("display","none");$("#mca-toolbar").css("display","none");$("#osc-toolbar").css("display","inline");$("#mca-container").css("display","none");$("#osc-container").css("display","inline");$("#log-container").css("display","none");$("#mca-1").removeClass("selectedtab");$("#mca-2").removeClass("selectedtab");$("#osc").addClass("selectedtab");$("#log").removeClass("selectedtab")}else{if(a==="log"){$("#mca-1-sidebar").css("display","none");$("#mca-2-sidebar").css("display","none");$("#osc-sidebar").css("display","none");$("#log-sidebar").css("display","inline");$("#mca-toolbar").css("display","none");$("#osc-toolbar").css("display","none");$("#mca-container").css("display","none");$("#osc-container").css("display","none");$("#log-container").css("display","inline");$("#mca-1").removeClass("selectedtab");$("#mca-2").removeClass("selectedtab");$("#osc").removeClass("selectedtab");$("#log").addClass("selectedtab")}}}}if(wsock!==null){console.log("readystate="+wsock.readyState)}if(wsock!==null&&wsock.readyState===1){update_toolbar_buttons(true);update_chart()}}function update_chart(){if(!init_complete){return}var a=localStorage.getItem(MCPHA_SELECTED_TAB);if(a==="mca-1"){chart=$.plot("#mca-chart",[mca1_data,{data:mca1_rois[0].data,color:"#a22"},{data:mca1_rois[1].data,color:"#a22"},{data:mca1_rois[2].data,color:"#a22"}],mca1_options);$("#roi1_counts").text(mca1_rois[0].count);$("#roi2_counts").text(mca1_rois[1].count);$("#roi3_counts").text(mca1_rois[2].count)}else{if(a==="mca-2"){chart=$.plot("#mca-chart",[mca2_data,{data:mca2_rois[0].data,color:"#a22"},{data:mca2_rois[1].data,color:"#a22"},{data:mca2_rois[2].data,color:"#a22"}],mca2_options);$("#roi1_counts").text(mca2_rois[0].count);$("#roi2_counts").text(mca2_rois[1].count);$("#roi3_counts").text(mca2_rois[2].count)}else{if(a==="osc"){var b=[];if(localStorage.getItem(MCPHA_OSC_1_IN)==="true"){b.push(osc1_data)}if(localStorage.getItem(MCPHA_OSC_2_IN)==="true"){b.push(osc2_data)}chart=$.plot("#osc-chart",b,osc_options)}}}};