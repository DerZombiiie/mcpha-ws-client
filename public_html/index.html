<!DOCTYPE html>
<!--
Copyright 2017 John Preston<byhisdeeds@gmail.com>.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
    <title>MCPHA Client</title>

    <link rel='shortcut icon' type='image/x-icon' href='favicon.ico' />

    <!-- CSS  -->
    <link href="css/material-icons.css" rel="stylesheet">
    <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen"/>
    <link href="css/animate.css" type="text/css" rel="stylesheet" media="screen"/>
    <link href="css/style.css" type="text/css" rel="stylesheet" media="screen"/>
  </head>
  <body>
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
    <script type="text/javascript" src="js/jquery.multilevelpushmenu.min.js"></script>
    <script type="text/javascript" src="js/long.js"></script>
    <script type="text/javascript" src="js/jquery.flot.min.js"></script>
    <script type="text/javascript" src="js/jquery.flot.selection.min.js"></script>
    <!-- <script type="text/javascript" src="js/jquery.flot.crosshair.min.js"></script> -->
    <script type="text/javascript" src="js/jquery.flot.axislabels.js"></script>
    <script type="text/javascript" src="js/jquery.flot.symbol.js"></script>
    <script type="text/javascript" src="js/download.min.js"></script>
    <script type="text/javascript" src="js/constants.min.js"></script>
    <script type="text/javascript" src="js/mca-utils.min.js"></script>
    <script type="text/javascript" src="js/mca-file-format.min.js"></script>

    <script type="text/javascript">
      //
      //
      //
      $(function () {
        
        // window resized handler
        var resize_handler = debounce(function () {
          resize_chart_div();
        }, 400);


        //
        // Redraw chart to resize div element that chart is bound to
        //
        function resize_chart_div() {
          adjust_vertical_scale_and_update(0);
          update_chart();
        }

        //
        // Initialise device connection status indicator
        //
        function update_device_connection_indicator(code) {
          devstatus = code;
          // update the connection icon
          if (devstatus === WEBSOCKET_CONNECTING) {
            $("#" + DEVICE_CONNECTION).text("signal_cellular_null");
            $("#" + DEVICE_CONNECTION).css("color", "orange");
          } else if (devstatus === WEBSOCKET_CONNECTED) {
            $("#" + DEVICE_CONNECTION).text("signal_cellular_4_bar");
            $("#" + DEVICE_CONNECTION).css("color", "white");
          } else if (devstatus === WEBSOCKET_DISCONNECTED) {
            $("#" + DEVICE_CONNECTION).text("signal_cellular_null");
            $("#" + DEVICE_CONNECTION).css("color", "white");
          } else if (devstatus === WEBSOCKET_ERROR) {
            $("#" + DEVICE_CONNECTION).text("signal_cellular_connected_no_internet_4_bar");
            $("#" + DEVICE_CONNECTION).css("color", "deep orange");
          }
          // update the tooltip
          var p = localStorage.getItem(MCPHA_DEVICE_ADDR);
          $("#" + DEVICE_CONNECTION).prop("title", "Device " +
            devstatus_string(devstatus) +
            " (" + ((p !== null && p !== 'undefined') ? p : "0.0.0.0") +
            ")");
        }

        //
        // Initialise websocket connection
        //
        function init_websocket(ws) {
          if (ws !== null && ws.readyState === 1) {
            ws.close();
          }

          update_device_connection_indicator(WEBSOCKET_CONNECTING);

          var wsuri = "ws://" + localStorage.getItem(MCPHA_DEVICE_ADDR);
          ws = new WebSocket(wsuri);
          ws.binaryType = 'arraybuffer'; // default is 'blob'

          ws.onopen = function () {
            log_status_message('Websocket connection established.', true);
            update_device_connection_indicator(WEBSOCKET_CONNECTED);
            init_device_state();
            // initialise device state
            //mcpha_send(MCPHA_COMMAND_SET_SAMPLE_RATE, 0, 4);
            //mcpha_send(MCPHA_COMMAND_SET_PHA_DELAY, 0, 100);
            // if mca mode then get histogram data
            /***
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === "mca-1") {
              mcpha_send(MCPHA_COMMAND_SET_PHA_MIN_THRESHOLD, 0,
                parseInt(localStorage.getItem(MCPHA_MCA_LLD)));
              mcpha_send(MCPHA_COMMAND_SET_PHA_MAX_THRESHOLD, 0,
                parseInt(localStorage.getItem(MCPHA_MCA_ULD)));
              // set whether mca channel 1 has negative input
              mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE, 0,
                localStorage.getItem(MCPHA_MCA_1_IN_NEG) === " true" ? 1 : 0);
              // request timer value
              mcpha_send(MCPHA_COMMAND_GET_TIMER, 0, 0);
              // request histogram data
              mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA, 0, 0);
            } else if (tab === "mca-2") {
              mcpha_send(MCPHA_COMMAND_SET_PHA_MIN_THRESHOLD, 1,
                parseInt(localStorage.getItem(MCPHA_MCA_LLD)));
              mcpha_send(MCPHA_COMMAND_SET_PHA_MAX_THRESHOLD, 1,
                parseInt(localStorage.getItem(MCPHA_MCA_ULD)));
              // set whether mca channel 1 has negative input
              mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE, 1,
                localStorage.getItem(MCPHA_MCA_2_IN_NEG) === " true" ? 1 : 0);
              // request timer value
              mcpha_send(MCPHA_COMMAND_GET_TIMER, 1, 0);
              // request histogram data
              mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA, 1, 0);
            } else if (tab === "osc") {

            }
    ***/
            // update toolbar buttons
            update_toolbar_buttons(true);
          };

          ws.onclose = function () {
            // if devstatus is not WEBSOCKET_ERROR
            // then we log the closed connection
            if (devstatus !== WEBSOCKET_ERROR) {
              log_status_message('Websocket connection closed.', true);
              devstatus = WEBSOCKET_DISCONNECTED;
            }
            // update toolbar buttons
            update_toolbar_buttons(false);
          };

          ws.onmessage = function (e) {
            if (e.data instanceof ArrayBuffer) {
              var r = new Uint32Array(e.data)[0];
              if (r === 0) {                // Timer 1 value
                var data = new Uint32Array(e.data, 4);
                var timer1 = data[1] * 4294967296 + data[0];
                if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-1") {
                  $("#elapsedtime").text((timer1 / TIMER_FREQ).toFixed(1));
                }
                if (timer1 >= mca1_acqtime && mca1_timer !== null) {
                  clearInterval(mca1_timer);
                  mca1_acq = false;
                  update_mca_acquisition_buttons_text(mca1_acq);
                }
              } else if (r === 1) {         // Timer 2 value
                var data = new Uint32Array(e.data, 4);
                var timer2 = data[1] * 4294967296 + data[0];
                if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-2") {
                  $("#elapsedtime").text((timer2 / TIMER_FREQ).toFixed(1));
                }
                if (timer2 >= mca2_acqtime && mca2_timer !== null) {
                  clearInterval(mca2_timer);
                  mca2_acq = false;
                  update_mca_acquisition_buttons_text(mca2_acq);
                }
              } else if (r === 2) {         // Channel 1 data
                var data = new Uint32Array(e.data, 4);
                mca1_data.length = 0;
                mca1_rois[0].count = 0;
                mca1_rois[0].data.length = 0;
                mca1_rois[1].count = 0;
                mca1_rois[1].data.length = 0;
                mca1_rois[2].count = 0;
                mca1_rois[2].data.length = 0;
                mca1_ymax = 0;
                for (let entry of data.entries()) {
                  if (mca1_ymax < entry[1]) {
                    mca1_ymax = entry[1];
                  }
                  mca1_data.push(entry);
                  for (let r of mca1_rois) {
                    if (entry[0] >= r.start && entry[0] <=r.end) {
                      r.data.push(entry);
                      r.count += entry[1];
                    }
                  }
                }
                // update cursor channel data
                update_cursor_pos(mca1_cursor, 0);
                //
                if (mca1_prev_ymax === -1) {
                  mca1_prev_ymax = mca1_ymax;
                  adjust_vertical_scale_and_update(0);
                } else if (auto_y_scale && (mca1_ymax > mca1_prev_ymax)) {
                  // adjust ymax up if auto yscale range enabled
                  adjust_vertical_scale_and_update(0);
                }
                update_mca1_chart();
              } else if (r === 3) {         // Channel 2 data
                var data = new Uint32Array(e.data, 4);
                mca2_data.length = 0;
                mca2_rois[0].count = 0;
                mca2_rois[0].data.length = 0;
                mca2_rois[1].count = 0;
                mca2_rois[1].data.length = 0;
                mca2_rois[2].count = 0;
                mca2_rois[2].data.length = 0;
                mca2_ymax = 0;
                for (let entry of data.entries()) {
                  if (mca2_ymax < entry[1]) {
                    mca2_ymax = entry[1];
                  }
                  mca2_data.push(entry);
                  for (let r of mca2_rois) {
                    if (entry[0] >= r.start && entry[0] <=r.end) {
                      r.data.push(entry);
                      r.count += entry[1];
                    }
                  }
                }
                // update cursor channel data
                update_cursor_pos(mca2_cursor, 0);
                //
                if (mca2_prev_ymax === -1) {
                  mca2_prev_ymax = mca2_ymax;
                  adjust_vertical_scale_and_update(0);
                } else if (auto_y_scale && (mca2_ymax > mca2_prev_ymax)) {
                  // adjust ymax up if auto yscale range enabled
                  adjust_vertical_scale_and_update(0);
                }
                update_mca2_chart();
              } else if (r === 4) {
                var status = new Uint32Array(e.data, 4)[0] & 1;
console.log("device status: ", status);
                if (osc_acq) {
                  if (status === 0) {
                    osc_acq = false;
                    mcpha_send(MCPHA_COMMAND_GET_OSCILLOSCOPE_DATA, 0, 0);
                    update_osc_acquisition_buttons_text(osc_acq);
                  } else {
                    mcpha_send(MCPHA_COMMAND_GET_OSCILLOSCOPE_STATUS, 0, 0);
                  }
                }
              } else if (r === 5) {         // Oscilloscope data
                var data = new Int16Array(e.data, 4);
console.log("oscilloscope length: ", data.length);
                osc1_data.length = 0;
                osc2_data.length = 0;
                for (var i=0; i<data.length; i+=2) {
                  var n = (i / 2) / OSC_X_AXIS_CONV_FACTOR;
                  var v = OSC_Y_AXIS_CONV_FACTOR * data[i];
                  osc1_data.push([n, v]);
                  v = OSC_Y_AXIS_CONV_FACTOR * data[i+1];
                  osc2_data.push([n, v]);
                }
                update_osc_chart();
              }
            }
          };

          ws.onerror = function () {
            update_device_connection_indicator(WEBSOCKET_ERROR);
            log_status_message('Websocket error', true);
            // set connection button state
            localStorage.setItem(MCPHA_CONNECT_DEVICE, "off");
            $('#' + MCPHA_CONNECT_DEVICE).prop('checked', false);
            // disable toolbar buttons
            update_toolbar_buttons(false);
          };

          return ws;
        }
        
        //
        //
        //
        function init_chart_handlers() {
          // initialise MCA chart options
          if (mca1_options === null) {
            mca1_options = default_mca_chart_options();
          }
          if (mca2_options === null) {
            mca2_options = default_mca_chart_options();
          }
          if (osc_options === null) {
            osc_options = default_osc_chart_options();
          }
          
          // set yscale
          set_yscale(localStorage.getItem(MCPHA_MCA_Y_SCALE));

          // set initial elapsedtime
          $("#mca-chart").bind("plotclick", function (event, pos, item) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === "mca-1") {
              if (mca1_cursor_mode === CURSOR_MODE_ZOOMIN) {
                zoom_in_around_cursor_xpos(pos.x.toFixed(0), mca1_data, chart.getAxes(), mca1_options, true);
              } else if (mca1_cursor_mode === CURSOR_MODE_ZOOMOUT) {
                zoom_out_around_cursor_xpos(pos.x.toFixed(0), mca1_data, chart.getAxes(), mca1_options, true);
              } else {
                mca1_cursor.channel = parseInt(pos.x.toFixed(0));
                update_cursor_pos(mca1_cursor, 0);
              }
            } else if (tab === "mca-2") {
              if (mca2_cursor_mode === CURSOR_MODE_ZOOMIN) {
                zoom_in_around_cursor_xpos(pos.x.toFixed(0), mca2_data, chart.getAxes(), mca2_options, true);
              } else if (mca2_cursor_mode === CURSOR_MODE_ZOOMOUT) {
                zoom_out_around_cursor_xpos(pos.x.toFixed(0), mca2_data, chart.getAxes(), mca2_options, true);
              } else {
                mca2_cursor.channel = parseInt(pos.x.toFixed(0));
                update_cursor_pos(mca2_cursor, 0);
              }
            }
          });

          $("#mca-chart").bind("plothover", function (event, pos, item) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === "mca-1" || tab === "mca-2") {
              var cursor_mode = tab === "mca-1" ? mca1_cursor_mode : tab === "mca-2" ? mca2_cursor_mode : "";
              if (chart.getData().length > 0) {
                if (cursor_mode === CURSOR_MODE_ZOOMIN) {
                  $("#mca-chart").css("cursor", "url(css/images/zoom-in.ico) 9 9, auto", "important");
                } else if (cursor_mode === CURSOR_MODE_ZOOMOUT) {
                  $("#mca-chart").css("cursor", "url(css/images/zoom-out.ico) 9 9, auto", "important");
                } else if (cursor_mode === CURSOR_MODE_PAN) {
                  $("#mca-chart").css("cursor", "move", "important");
                } else if (cursor_mode === CURSOR_MODE_SETROI_1 || cursor_mode === CURSOR_MODE_SETROI_2 || cursor_mode !== CURSOR_MODE_SETROI_3) {
                  $("#mca-chart").css("cursor", "crosshair", "important");
                } else {
                  $("#mca-chart").css("cursor", "pointer", "important");
                }
              } else {
                $("#spectrum-placeholder").css("cursor", "pointer", "important");
              }
            }
          });

          //
          // ROI selection handler
          //
          $("#mca-chart").bind("plotselected", function (event, ranges) {
            // save roi range
            save_roi_range(ranges.xaxis.from.toFixed(0), ranges.xaxis.to.toFixed(0));
            chart.clearSelection();
            set_cursor_mode(CURSOR_MODE_CLEAR_ALL);
            update_chart();
          });
        }

        //
        //
        //
        function save_roi_range(from, to) {
          var roi = parseInt(mca1_cursor_mode.charAt(1));
          var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
          if (tab === "mca-1") {
            var r = mca1_rois[roi-1];
            r.start = from;
            r.end = to;
            r.count = 0;
            r.data.length = 0;
            for (var n=r.start; n<r.end; n++) {
              r.data.push(mca1_data[n]);
              r.count += parseInt(mca1_data[n][1]);
            }
          } else if (tab === "mca-2") {
            var r = mca2_rois[roi-1];
            r.start = from;
            r.end = to;
            r.count = 0;
            r.data.length = 0;
            for (var n=r.start; n<r.end; n++) {
              r.data.push(mca2_data[n]);
              r.count += parseInt(mca2_data[n][1]);
            }
          }
          // update roi tooltip
          $("#roi"+roi+"_counts").prop("title", "From channel "+from+" to "+to);
        }
        
        //
        //
        //
        function zoom_in_around_cursor_xpos(xpos, data, axes, options, refresh) {
          if (data.length > 0) {
            // zoom in by a factor of 2
            var dmin = parseInt(axes.xaxis.datamin);
            var dmax = parseInt(axes.xaxis.datamax);
            var xmin = parseInt(options.xaxis.min);
            var xmax = parseInt(options.xaxis.max);
            var xrng = (xmax - xmin) / 2;
            if (xrng > 100) {
              xrng /= 2;
              xmin += (parseInt(xpos) - xmin) / 2;
              xmax -= (xmax - parseInt(xpos)) / 2;
              if (xmin < dmin) {
                xmin = dmin;
                xmax = xmin + (xrng * 2);
              } else if (xmax > dmax) {
                xmax = dmax;
                xmin = xmax - (xrng * 2);
              }
              options.xaxis.min = xmin;
              options.xaxis.max = xmax;
              options.xaxis.tickSize = get_zoom_ticks(xmin, xmax, options);
              if (refresh) {
                update_chart();
              }
            }
          }
        }

        //
        //
        //
        function zoom_out_around_cursor_xpos(xpos, data, axes, options, refresh) {
          if (data.length > 0) {
            // zoom out by a factor of 2
            var dmin = parseInt(axes.xaxis.datamin);
            var dmax = parseInt(axes.xaxis.datamax);
            var xmin = parseInt(options.xaxis.min);
            var xmax = parseInt(options.xaxis.max);
            var xrng = xmax - xmin;
            if (xrng * 2 > (dmax - dmin)) {
              xmin = dmin;
              xmax = dmax;
            } else {
              xmin -= xrng;
              xmax += xrng;
              if (xmin < dmin) {
                xmin = dmin;
                xmax = xmin + (xrng * 2);
              } else if (xmax > dmax) {
                xmax = dmax;
                xmin = xmax - (xrng * 2);
              }
            }
            options.xaxis.min = xmin;
            options.xaxis.max = xmax;
            options.xaxis.tickSize = get_zoom_ticks(xmin, xmax, options);
            console.log("options:" + options.toString());
            if (refresh) {
              update_chart();
            }
          }
        }

        //
        //
        //
        function get_zoom_ticks(xmin, xmax, options) {
          if (options.yaxis.transform === null) {
            var xrng = xmax - xmin;
            if (xrng < 100) {
              t = 10;
            } else if (xrng < 500) {
              t = 50;
            } else if (xrng < 1000) {
              t = 100;
            } else if (xrng < 2000) {
              t = 200;
            } else if (xrng < 5000) {
              t = 500;
            } else if (xrng < 10000) {
              t = 1000;
            } else {
              t = 1000;
            }
            return t;
          } else {
            return 0;
          }
        }


        //
        //
        //
        function adjust_vertical_scale_and_update(adjustment) {
          var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
          if (tab === "mca-1") {
            adjust_vertical_scale(mca1_options, mca1_ymax, auto_y_scale, adjustment);
          } else if (tab === "mca-2") {
            adjust_vertical_scale(mca2_options, mca2_ymax, auto_y_scale, adjustment);
          }
          update_chart();
        }

        //
        //
        //
        function adjust_vertical_scale(options, ymax, auto_scale, adjustment) {
          var yscale = localStorage.getItem(MCPHA_MCA_Y_SCALE);
//console.log("adjust_vertical_scale - y_scale="+yscale+", ymax="+ymax+", auto_scale="+auto_scale+", adjustment="+adjustment);
          if (ymax === 0) {               // Initialise Y scale range and ticks
            if (yscale === "lin") {
              options.yaxis.range_index = 2;
              options.yaxis.max = YAXIS_LIN_TICKS[options.yaxis.range_index].ymax;
              options.yaxis.ticks = YAXIS_LIN_TICKS[options.yaxis.range_index].ticks;
//console.log("INIT lin - options.yaxis.range_index="+options.yaxis.range_index+", options.yaxis.max="+options.yaxis.max+", options.yaxis.ticks="+options.yaxis.ticks);
            } else if (yscale === "log") {
              options.yaxis.range_index = 2;
              options.yaxis.max = YAXIS_LOG_TICKS[options.yaxis.range_index].ymax;
              options.yaxis.ticks = YAXIS_LOG_TICKS[options.yaxis.range_index].ticks;
//console.log("INIT log - options.yaxis.range_index="+options.yaxis.range_index+", options.yaxis.max="+options.yaxis.max+", options.yaxis.ticks="+options.yaxis.ticks);
            }
          } else if (adjustment > 0) {    // Increment Y scale range
            if (yscale === "lin") {
              for (var i = 0; i < VERT_LIN_RANGE.length - 1; i++) {
                if (options.yaxis.max <= VERT_LIN_RANGE[i]) {
                  options.yaxis.range_index = i + 1;
                  options.yaxis.max = YAXIS_LIN_TICKS[options.yaxis.range_index].ymax;
                  options.yaxis.ticks = YAXIS_LIN_TICKS[options.yaxis.range_index].ticks;
//console.log("INC lin - options.yaxis.range_index="+options.yaxis.range_index+", options.yaxis.max="+options.yaxis.max+", options.yaxis.ticks="+options.yaxis.ticks);
                  break;
                }
              }
            } else if (yscale === "log") {
              for (var i = 0; i < VERT_LOG_RANGE.length - 1; i++) {
                if (options.yaxis.max <= VERT_LOG_RANGE[i]) {
                  options.yaxis.range_index = i + 1;
                  options.yaxis.max = YAXIS_LOG_TICKS[options.yaxis.range_index].ymax;
                  options.yaxis.ticks = YAXIS_LOG_TICKS[options.yaxis.range_index].ticks;
//console.log("INC log - options.yaxis.range_index="+options.yaxis.range_index+", options.yaxis.max="+options.yaxis.max+", options.yaxis.ticks="+options.yaxis.ticks);
                  break;
                }
              }
            }
          } else if (adjustment < 0) {    // Decrement Y scale range
            if (yscale === "lin") {
              for (var i = VERT_LIN_RANGE.length - 1; i > 0; i--) {
                if (options.yaxis.max >= VERT_LIN_RANGE[i]) {
                  options.yaxis.range_index = i - 1;
                  options.yaxis.max = YAXIS_LIN_TICKS[options.yaxis.range_index].ymax;
                  options.yaxis.ticks = YAXIS_LIN_TICKS[options.yaxis.range_index].ticks;
//console.log("DEC lin - options.yaxis.range_index="+options.yaxis.range_index+", options.yaxis.max="+options.yaxis.max+", options.yaxis.ticks="+options.yaxis.ticks);
                  break;
                }
              }
            } else if (yscale === "log") {
              for (var i = VERT_LOG_RANGE.length - 1; i > 0; i--) {
                if (options.yaxis.max >= VERT_LOG_RANGE[i]) {
                  options.yaxis.range_index = i - 1;
                  options.yaxis.max = YAXIS_LOG_TICKS[options.yaxis.range_index].ymax;
                  options.yaxis.ticks = YAXIS_LOG_TICKS[options.yaxis.range_index].ticks;
//console.log("DEC log - options.yaxis.range_index="+options.yaxis.range_index+", options.yaxis.max="+options.yaxis.max+", options.yaxis.ticks="+options.yaxis.ticks);
                  break;
                }
              }
            }
          } else if (adjustment === 0 || auto_scale) {  // Update Y scale range / autoscale
            if (yscale === "lin") {
              for (var i = 0; i < VERT_LIN_RANGE.length; i++) {
                if (ymax < VERT_LIN_RANGE[i]) {
                  options.yaxis.range_index = i;
                  options.yaxis.max = YAXIS_LIN_TICKS[options.yaxis.range_index].ymax;
                  options.yaxis.ticks = YAXIS_LIN_TICKS[options.yaxis.range_index].ticks;
//console.log("ADJ0 lin - options.yaxis.range_index="+options.yaxis.range_index+", options.yaxis.max="+options.yaxis.max+", options.yaxis.ticks="+options.yaxis.ticks);
                  break;
                }
              }
            } else if (yscale === "log") {
              for (var i = 0; i < VERT_LOG_RANGE.length; i++) {
                if (ymax < VERT_LOG_RANGE[i]) {
                  options.yaxis.range_index = i;
                  options.yaxis.max = YAXIS_LOG_TICKS[options.yaxis.range_index].ymax;
                  options.yaxis.ticks = YAXIS_LOG_TICKS[options.yaxis.range_index].ticks;
//console.log("ADJ0 log - options.yaxis.range_index="+options.yaxis.range_index+", options.yaxis.max="+options.yaxis.max+", options.yaxis.ticks="+options.yaxis.ticks);
                  break;
                }
              }
            }
          }
        }

        //
        //
        //
        function set_cursor_mode(mode) {
          var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
          if (tab === "mca-1") {
            return (mca1_cursor_mode = set_cursor_mode_options(mode, mca1_cursor_mode, mca1_options, mca1_rois));
          } else if (tab === "mca-2") {
            return (mca2_cursor_mode, set_cursor_mode_options(mode, mca2_cursor_mode, mca2_options, mca2_rois));
          } else if (tab === "osc") {
            return (osc_cursor_mode = set_cursor_mode_options(mode, osc_cursor_mode, osc_options));
          }
          return null;
        }

        //
        //
        //
        function set_cursor_mode_options(mode, current_mode, options, rois) {
          $("#zoomin").removeClass(HIGHLIGHT_BUTTON);
          if (mode === CURSOR_MODE_ZOOMIN) {
            options.selection.mode = null;
            if (current_mode === mode) {
              $("#zoomin").removeClass(HIGHLIGHT_BUTTON);
              log_status_message("ZOOM mode OFF", true);
              return CURSOR_MODE_CLEAR_ALL;
            } else {
              $("#zoomout").removeClass(HIGHLIGHT_BUTTON);
              $("#zoomin").addClass(HIGHLIGHT_BUTTON);
              log_status_message("ZOOM mode IN", true);
              return mode;
            }
          } else if (mode === CURSOR_MODE_ZOOMOUT) {
            options.selection.mode = null;
            if (current_mode === mode) {
              $("#zoomout").removeClass(HIGHLIGHT_BUTTON);
              log_status_message("ZOOM mode OFF", true);
              return CURSOR_MODE_CLEAR_ALL;
            } else {
              $("#zoomin").removeClass(HIGHLIGHT_BUTTON);
              $("#zoomout").addClass(HIGHLIGHT_BUTTON);
              log_status_message("ZOOM mode OUT", true);
              return mode;
            }
          } else if (mode === CURSOR_MODE_SETROI_1) {
            if (current_mode === mode) {
              $("#roi1_container").removeClass(ROI_HIGHLIGHT);
              options.selection.mode = null;
              log_status_message("Set ROI #1 mode OFF", true);
              return CURSOR_MODE_CLEAR_ALL;
            } else {
              $("#roi2_container").removeClass(ROI_HIGHLIGHT);
              $("#roi3_container").removeClass(ROI_HIGHLIGHT);
              $("#roi1_container").addClass(ROI_HIGHLIGHT);
              options.selection.mode = "x";
              log_status_message("Set ROI #1 mode ON", true);
              return mode;
            }
          } else if (mode === CURSOR_MODE_SETROI_2) {
            if (current_mode === mode) {
              $("#roi2_container").removeClass(ROI_HIGHLIGHT);
              options.selection.mode = null;
              log_status_message("Set ROI #2 mode OFF", true);
              return CURSOR_MODE_CLEAR_ALL;
            } else {
              $("#roi1_container").removeClass(ROI_HIGHLIGHT);
              $("#roi3_container").removeClass(ROI_HIGHLIGHT);
              $("#roi2_container").addClass(ROI_HIGHLIGHT);
              options.selection.mode = "x";
              log_status_message("Set ROI #2 mode ON", true);
              return mode;
            }
          } else if (mode === CURSOR_MODE_SETROI_3) {
            if (current_mode === mode) {
              $("#roi3_container").removeClass(ROI_HIGHLIGHT);
              options.selection.mode = null;
              log_status_message("Set ROI #1 mode OFF", true);
              return CURSOR_MODE_CLEAR_ALL;
            } else {
              $("#roi1_container").removeClass(ROI_HIGHLIGHT);
              $("#roi2_container").removeClass(ROI_HIGHLIGHT);
              $("#roi3_container").addClass(ROI_HIGHLIGHT);
              options.selection.mode = "x";
              log_status_message("Set ROI #3 mode ON", true);
              return mode;
            }
          } else if (mode === CURSOR_MODE_CLEAR_ROIS) {
            for (var i=0; i<3; i++) {
              rois[i].start = -1;
              rois[i].end = -1;
              rois[i].count = 0;
              rois[i].data.length = 0;
            }
            $("#roi1_container").removeClass(ROI_HIGHLIGHT);
            $("#roi2_container").removeClass(ROI_HIGHLIGHT);
            $("#roi3_container").removeClass(ROI_HIGHLIGHT);
            options.selection.mode = null;
            log_status_message("ROI's cleared", true);
            return CURSOR_MODE_CLEAR_ALL;
          } else if (mode === CURSOR_MODE_CLEAR_ALL) {
            $("#roi1_container").removeClass(ROI_HIGHLIGHT);
            $("#roi2_container").removeClass(ROI_HIGHLIGHT);
            $("#roi3_container").removeClass(ROI_HIGHLIGHT);
            $("#zoomin").removeClass("darken-2");
            $("#zoomout").removeClass("darken-2");
            options.selection.mode = null;
            return mode;
          }
        }

        //
        // Toggle sidebar
        //
        function toggle_sidebar() {
          $('#slide-menu').toggleClass('open-side-nav');
          $('#slide-body').toggleClass('open-body-nav');

          // save sidebar open state
          if ($('#slide-menu').hasClass('open-side-nav')) {
            localStorage.setItem(MCPHA_SIDEBAR_OPEN, 'true');
          } else {
            localStorage.removeItem(MCPHA_SIDEBAR_OPEN);
          }
          // HACK to resize chart div
          setTimeout(function () {
            resize_chart_div();
          }, 120);
        }
        ;

        //
        // Set Y scale mode to Linear or Logarithmic
        //
        function set_yscale(mode) {
          if (mode === "lin") {
            localStorage.setItem(MCPHA_MCA_Y_SCALE, mode);
            $('#linscale').addClass(HIGHLIGHT_BUTTON);
            $('#logscale').removeClass(HIGHLIGHT_BUTTON);
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            var ch = (tab === "mca-1") ? 1 : (tab === "mca-2") ? 2 : -1;
            if (ch === 1) {
              //mca1_options.yaxis.max = mca1_prev_ymax;
              mca1_options.yaxis.ticks = null;
              mca1_options.yaxis.transform = null;
              mca1_options.yaxis.tickDecimals = 0;
              mca1_options.yaxis.tickFormatter = null;
            } else if (ch === 2) {
              //mca2_options.yaxis.max = mca2_prev_ymax;
              mca2_options.yaxis.ticks = null;
              mca2_options.yaxis.transform = null;
              mca2_options.yaxis.tickDecimals = 0;
              mca2_options.yaxis.tickFormatter = null;
            }
          } else if (mode === "log") {
            localStorage.setItem(MCPHA_MCA_Y_SCALE, mode);
            $('#linscale').removeClass(HIGHLIGHT_BUTTON);
            $('#logscale').addClass(HIGHLIGHT_BUTTON);
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            var ch = (tab === "mca-1") ? 1 : (tab === "mca-2") ? 2 : -1;
            if (ch === 1) {
              mca1_options.yaxis.transform = function(v) {
                return Math.log(v+0.0001); /*move away from zero*/
              };
              mca1_options.yaxis.tickFormatter = function (v, axis) {
                return "10" + (Math.round( Math.log(v)/Math.LN10)).toString().sup();
              };
              //mca1_prev_ymax = mca1_options.yaxis.max;
              adjust_vertical_scale_and_update(0);
            } else if (ch === 2) {
              mca2_options.yaxis.transform = function(v) {
                return Math.log(v+0.0001); /*move away from zero*/
              };
              //mca2_options.yaxis.tickDecimals = 2;
              mca2_options.yaxis.tickFormatter = function (v, axis) {
                return "10" + (Math.round( Math.log(v)/Math.LN10)).toString().sup();
              };
              //mca2_prev_ymax = mca2_options.yaxis.max;
              //mca2_options.yaxis.max = mca2_y_range[mca2_y_range.length-1];
            }
          } else {
            $('#linscale').removeClass(HIGHLIGHT_BUTTON);
            $('#logscale').removeClass(HIGHLIGHT_BUTTON);
          }
        }

        //
        //
        //
        function update_osc_acquisition_buttons_text(active) {
          $('#getoscdata').html(active ? CANCEL_OSCILLOSCOPE_ACQUISITION_TEXT : GET_OSCILLOSCOPE_DATA_TEXT);
          if (active) {
            $('#net-traffic').addClass("infinite");
            $('#net-traffic').addClass("white-text");
            log_status_message("Starting oscilloscope acquisition", false);
          } else {
            $('#net-traffic').removeClass("infinite");
            $('#net-traffic').removeClass("white-text");
            log_status_message("Stopping oscilloscope acquisition", false);
          }
        }

        //
        // install settings update handlers
        //
        function init_settings_handlers() {
          var s;
          // Device address
          $('#' + MCPHA_DEVICE_ADDR).on('input', function (e) {
            localStorage.setItem(MCPHA_DEVICE_ADDR, $('#' + MCPHA_DEVICE_ADDR).val());
          });
          s = localStorage.getItem(MCPHA_DEVICE_ADDR);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_DEVICE_ADDR).val(s);
          } else {
            localStorage.setItem(MCPHA_DEVICE_ADDR, $('#' + MCPHA_DEVICE_ADDR).val());
          }

          // Connect device
          $('#' + MCPHA_CONNECT_DEVICE).on('click', function (e) {
            var on = $('#' + MCPHA_CONNECT_DEVICE).prop('checked');
            localStorage.setItem(MCPHA_CONNECT_DEVICE, on ? "on" : "off");
            if (on) {
              wsock = init_websocket(wsock);
            } else {
              if (wsock !== null && wsock.readyState === 1) {
                wsock.close();
              }
              wsock = null;
            }
          });
          s = localStorage.getItem(MCPHA_CONNECT_DEVICE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_CONNECT_DEVICE).prop('checked', s === "on");
          } else {
            localStorage.setItem(MCPHA_CONNECT_DEVICE, $('#' + MCPHA_CONNECT_DEVICE).prop('checked') ? "on" : "off");
          }

          // Decimation factor (between 4 and 8192)
          $('#' + MCPHA_DEC_FACTOR).on('input', function (e) {
            // TODO: ensure number is between 4 and 8192 in increments of 4
            localStorage.setItem(MCPHA_DEC_FACTOR, $('#' + MCPHA_DEC_FACTOR).val());
          });
          s = localStorage.getItem(MCPHA_DEC_FACTOR);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_DEC_FACTOR).val(s);
          } else {
            localStorage.setItem(MCPHA_DEC_FACTOR, $('#' + MCPHA_DEC_FACTOR).val());
          }

          // MCA LLD
          $('#' + MCPHA_MCA_LLD).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_LLD, $('#' + MCPHA_MCA_LLD).val());
          });
          s = localStorage.getItem(MCPHA_MCA_LLD);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_LLD).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_LLD, $('#' + MCPHA_MCA_LLD).val());
          }

          // MCA ULD
          $('#' + MCPHA_MCA_ULD).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_ULD, $('#' + MCPHA_MCA_ULD).val());
          });
          s = localStorage.getItem(MCPHA_MCA_ULD);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_ULD).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_ULD, $('#' + MCPHA_MCA_ULD).val());
          }

          // Auto Y scale
          $('#' + MCPHA_MCA_AUTO_Y_SCALE).on('click', function (e) {
            auto_y_scale = $('#' + MCPHA_MCA_AUTO_Y_SCALE).prop('checked') ? true : false;
            localStorage.setItem(MCPHA_MCA_AUTO_Y_SCALE, auto_y_scale);
            adjust_vertical_scale_and_update(0);
          });
          s = localStorage.getItem(MCPHA_MCA_AUTO_Y_SCALE);
          if (s !== null && s !== 'undefined') {
            auto_y_scale = (s === "true");
          } else {
            auto_y_scale = false;
          }
          $('#' + MCPHA_MCA_AUTO_Y_SCALE).prop('checked', auto_y_scale); 

          // MCA 1 input negative
          $('#' + MCPHA_MCA_1_IN_NEG).on('click', function (e) {
            localStorage.setItem(MCPHA_MCA_1_IN_NEG, $('#' + MCPHA_MCA_1_IN_NEG).prop('checked') ? "true" : "false");
          });
          s = localStorage.getItem(MCPHA_MCA_1_IN_NEG);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_IN_NEG).prop('checked', s === "true");
          } else {
            localStorage.setItem(MCPHA_MCA_1_IN_NEG, $('#' + MCPHA_MCA_1_IN_NEG).prop('checked') ? "true" : "false");
          }

          // MCA 1 acquisition time (seconds)
          $('#' + MCPHA_MCA_1_ACQ_TIME).on('input', function (e) {
            localStorage.setItem(MCPHA_MCA_1_ACQ_TIME, $('#' + MCPHA_MCA_1_ACQ_TIME).val());
            $("#acqtime_s").text($('#' + MCPHA_MCA_1_ACQ_TIME).val());
          });
          s = localStorage.getItem(MCPHA_MCA_1_ACQ_TIME);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_ACQ_TIME).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_1_ACQ_TIME, $('#' + MCPHA_MCA_1_ACQ_TIME).val());
          }

          // MCA 1 trigger mode (normal or automatic)
          $('#' + MCPHA_MCA_1_TRIG_MODE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_1_TRIG_MODE, $('#' + MCPHA_MCA_1_TRIG_MODE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_1_TRIG_MODE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_TRIG_MODE).val(s);
            $('#' + MCPHA_MCA_1_TRIG_MODE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_1_TRIG_MODE, $('#' + MCPHA_MCA_1_TRIG_MODE).val());
          }

          // MCA 1 trigger source (channel 1 or channel 2)
          $('#' + MCPHA_MCA_1_TRIG_SOURCE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_1_TRIG_SOURCE, $('#' + MCPHA_MCA_1_TRIG_SOURCE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_1_TRIG_SOURCE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_TRIG_SOURCE).val(s);
            $('#' + MCPHA_MCA_1_TRIG_SOURCE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_1_TRIG_SOURCE, $('#' + MCPHA_MCA_1_TRIG_SOURCE).val());
          }

          // MCA 1 trigger edge (rising or falling)
          $('#' + MCPHA_MCA_1_TRIG_EDGE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_1_TRIG_EDGE, $('#' + MCPHA_MCA_1_TRIG_EDGE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_1_TRIG_EDGE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_TRIG_EDGE).val(s);
            $('#' + MCPHA_MCA_1_TRIG_EDGE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_1_TRIG_EDGE, $('#' + MCPHA_MCA_1_TRIG_EDGE).val());
          }

          // MCA 1 Trigger level
          $('#' + MCPHA_MCA_1_TRIG_LEVEL).on('input', function (e) {
            localStorage.setItem(MCPHA_MCA_1_TRIG_LEVEL, $('#' + MCPHA_MCA_1_TRIG_LEVEL).val());
          });
          s = localStorage.getItem(MCPHA_MCA_1_TRIG_LEVEL);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_TRIG_LEVEL).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_1_TRIG_LEVEL, $('#' + MCPHA_MCA_1_TRIG_LEVEL).val());
          }

          // MCA 2 input negative
          $('#' + MCPHA_MCA_2_IN_NEG).on('click', function (e) {
            localStorage.setItem(MCPHA_MCA_2_IN_NEG, $('#' + MCPHA_MCA_2_IN_NEG).prop('checked') ? "true" : "false");
          });
          s = localStorage.getItem(MCPHA_MCA_2_IN_NEG);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_IN_NEG).prop('checked', s === "true");
          } else {
            localStorage.setItem(MCPHA_MCA_2_IN_NEG, $('#' + MCPHA_MCA_2_IN_NEG).prop('checked') ? "true" : "false");
          }

          // MCA 2 acquisition time (seconds)
          $('#' + MCPHA_MCA_2_ACQ_TIME).on('input', function (e) {
            localStorage.setItem(MCPHA_MCA_2_ACQ_TIME, $('#' + MCPHA_MCA_2_ACQ_TIME).val());
            $("#acqtime_s").text($('#' + MCPHA_MCA_2_ACQ_TIME).val());
          });
          s = localStorage.getItem(MCPHA_MCA_2_ACQ_TIME);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_ACQ_TIME).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_2_ACQ_TIME, $('#' + MCPHA_MCA_2_ACQ_TIME).val());
          }

          // MCA 2 trigger mode (normal or automatic)
          $('#' + MCPHA_MCA_2_TRIG_MODE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_2_TRIG_MODE, $('#' + MCPHA_MCA_2_TRIG_MODE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_2_TRIG_MODE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_TRIG_MODE).val(s);
            $('#' + MCPHA_MCA_2_TRIG_MODE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_2_TRIG_MODE, $('#' + MCPHA_MCA_2_TRIG_MODE).val());
          }

          // MCA 2 trigger source (channel 1 or channel 2)
          $('#' + MCPHA_MCA_2_TRIG_SOURCE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_2_TRIG_SOURCE, $('#' + MCPHA_MCA_2_TRIG_SOURCE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_2_TRIG_SOURCE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_TRIG_SOURCE).val(s);
            $('#' + MCPHA_MCA_2_TRIG_SOURCE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_2_TRIG_SOURCE, $('#' + MCPHA_MCA_2_TRIG_SOURCE).val());
          }

          // MCA 2 trigger edge (rising or falling)
          $('#' + MCPHA_MCA_2_TRIG_EDGE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_2_TRIG_EDGE, $('#' + MCPHA_MCA_2_TRIG_EDGE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_2_TRIG_EDGE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_TRIG_EDGE).val(s);
            $('#' + MCPHA_MCA_2_TRIG_EDGE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_2_TRIG_EDGE, $('#' + MCPHA_MCA_2_TRIG_EDGE).val());
          }

          // MCA 2 Trigger level
          $('#' + MCPHA_MCA_2_TRIG_LEVEL).on('input', function (e) {
            localStorage.setItem(MCPHA_MCA_2_TRIG_LEVEL, $('#' + MCPHA_MCA_2_TRIG_LEVEL).val());
          });
          s = localStorage.getItem(MCPHA_MCA_2_TRIG_LEVEL);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_TRIG_LEVEL).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_2_TRIG_LEVEL, $('#' + MCPHA_MCA_2_TRIG_LEVEL).val());
          }

          // Oscilloscope channel 1 input
          $('#' + MCPHA_OSC_1_IN).on('click', function (e) {
            localStorage.setItem(MCPHA_OSC_1_IN, $('#' + MCPHA_OSC_1_IN).prop('checked') ? "true" : "false");
          });
          s = localStorage.getItem(MCPHA_OSC_1_IN);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_1_IN).prop('checked', s === "true");
          } else {
            localStorage.setItem(MCPHA_OSC_1_IN, $('#' + MCPHA_OSC_1_IN).prop('checked') ? "true" : "false");
          }

          // Oscilloscope channel 2 input
          $('#' + MCPHA_OSC_2_IN).on('click', function (e) {
            localStorage.setItem(MCPHA_OSC_2_IN, $('#' + MCPHA_OSC_2_IN).prop('checked') ? "true" : "false");
          });
          s = localStorage.getItem(MCPHA_OSC_2_IN);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_2_IN).prop('checked', s === "true");
          } else {
            localStorage.setItem(MCPHA_OSC_2_IN, $('#' + MCPHA_OSC_2_IN).prop('checked') ? "true" : "false");
          }

          // Oscilloscope trigger mode (normal or automatic)
          $('#' + MCPHA_OSC_TRIG_MODE).on('change', function (e) {
            localStorage.setItem(MCPHA_OSC_TRIG_MODE, $('#' + MCPHA_OSC_TRIG_MODE).val());
          });
          s = localStorage.getItem(MCPHA_OSC_TRIG_MODE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_TRIG_MODE).val(s);
            $('#' + MCPHA_OSC_TRIG_MODE).material_select();
          } else {
            localStorage.setItem(MCPHA_OSC_TRIG_MODE, $('#' + MCPHA_OSC_TRIG_MODE).val());
          }

          // Oscilloscope trigger source (channel 1 or channel 2)
          $('#' + MCPHA_OSC_TRIG_SOURCE).on('change', function (e) {
            localStorage.setItem(MCPHA_OSC_TRIG_SOURCE, $('#' + MCPHA_OSC_TRIG_SOURCE).val());
          });
          s = localStorage.getItem(MCPHA_OSC_TRIG_SOURCE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_TRIG_SOURCE).val(s);
            $('#' + MCPHA_OSC_TRIG_SOURCE).material_select();
          } else {
            localStorage.setItem(MCPHA_OSC_TRIG_SOURCE, $('#' + MCPHA_OSC_TRIG_SOURCE).val());
          }

          // Oscilloscope trigger edge (rising or falling)
          $('#' + MCPHA_OSC_TRIG_EDGE).on('change', function (e) {
            localStorage.setItem(MCPHA_OSC_TRIG_EDGE, $('#' + MCPHA_OSC_TRIG_EDGE).val());
          });
          s = localStorage.getItem(MCPHA_OSC_TRIG_EDGE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_TRIG_EDGE).val(s);
            $('#' + MCPHA_OSC_TRIG_EDGE).material_select();
          } else {
            localStorage.setItem(MCPHA_OSC_TRIG_EDGE, $('#' + MCPHA_OSC_TRIG_EDGE).val());
          }

          // Oscilloscope trigger level
          $('#' + MCPHA_OSC_TRIG_LEVEL).on('input', function (e) {
            localStorage.setItem(MCPHA_OSC_TRIG_LEVEL, $('#' + MCPHA_OSC_TRIG_LEVEL).val());
          });
          s = localStorage.getItem(MCPHA_OSC_TRIG_LEVEL);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_TRIG_LEVEL).val(s);
          } else {
            localStorage.setItem(MCPHA_OSC_TRIG_LEVEL, $('#' + MCPHA_OSC_TRIG_LEVEL).val());
          }
        }

        //
        //
        //
        function init_tool_handlers() {
          $('#enableacq').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === "mca-1") {
              if (mca1_acq) {
                // Stop acquisition
                mcpha_send(MCPHA_COMMAND_SET_TIMER_MODE, 0, 0);
                // stop update request timer
                clearInterval(mca1_timer);
              } else {
                // Start acquisition
                mcpha_send(MCPHA_COMMAND_SET_PHA_MIN_THRESHOLD, 0, parseInt(localStorage.getItem(MCPHA_MCA_LLD)));
                mcpha_send(MCPHA_COMMAND_SET_PHA_MAX_THRESHOLD, 0, parseInt(localStorage.getItem(MCPHA_MCA_ULD)));
                // set whether mca channel 1 has negative input
                mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE, 0, localStorage.getItem(MCPHA_MCA_1_IN_NEG) === " true" ? 1 : 0);
                // set acquisitgion time
                mca1_acqtime = parseInt(localStorage.getItem(MCPHA_MCA_1_ACQ_TIME)) * TIMER_FREQ;
                mcpha_send(MCPHA_COMMAND_SET_TIMER_VALUE, 0, mca1_acqtime);
                // set timer mode
                mcpha_send(MCPHA_COMMAND_SET_TIMER_MODE, 0, 1);
                // activate timer to request periodic updates
                if (mca1_timer !== null) {
                  clearInterval(mca1_timer);
                }
                mca1_timer = setInterval(function () {
                  // request timer value
                  mcpha_send(MCPHA_COMMAND_GET_TIMER, 0, 0);
                  // request either histogram or oscilloscope data
                  if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-1") {
                    mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA, 0, 0);
                  } else if (localStorage.getItem(MCPHA_SELECTED_TAB) === "osc") {
                  }
                }, 1000);
              }
              // toggle acquisition flag and update acquisition button text
              mca1_acq = !mca1_acq;
              update_mca_acquisition_buttons_text(mca1_acq);
            } else if (tab === "mca-2") {
              if (mca2_acq) {
                // Stop acquisition
                mcpha_send(MCPHA_COMMAND_SET_TIMER_MODE, 1, 0);
                // stop update request timer
                clearInterval(mca2_timer);
              } else {
                // Start acquisition
                mcpha_send(MCPHA_COMMAND_SET_PHA_MIN_THRESHOLD, 1, parseInt(localStorage.getItem(MCPHA_MCA_LLD)));
                mcpha_send(MCPHA_COMMAND_SET_PHA_MAX_THRESHOLD, 1, parseInt(localStorage.getItem(MCPHA_MCA_ULD)));
                // set whether mca channel 1 has negative input
                mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE, 1, localStorage.getItem(MCPHA_MCA_2_IN_NEG) === " true" ? 1 : 0);
                // set acquisition time
                mca2_acqtime = parseInt(localStorage.getItem(MCPHA_MCA_2_ACQ_TIME)) * TIMER_FREQ;
                mcpha_send(MCPHA_COMMAND_SET_TIMER_VALUE, 1, mca2_acqtime);
                // set timer mode
                mcpha_send(MCPHA_COMMAND_SET_TIMER_MODE, 1, 1);
                // activate timer to request periodic updates
                if (mca2_timer !== null) {
                  clearInterval(mca2_timer);
                }
                mca2_timer = setInterval(function () {
                  // request timer value
                  mcpha_send(MCPHA_COMMAND_GET_TIMER, 1, 0);
                  // request either histogram or oscilloscope data
                  if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-2") {
                    // request histogram data
                    mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA, 1, 0);
                  } else if (localStorage.getItem(MCPHA_SELECTED_TAB) === "osc") {
                  }
                }, 1000);
              }
              // toggle acquisition flag and update acquisition button text
              mca2_acq = !mca2_acq;
              update_mca_acquisition_buttons_text(mca2_acq);
            }
          });

          // clear timer button click handler
          $('#cleartimer').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === "mca-1") {
              // Reset timer
              mcpha_send(MCPHA_COMMAND_RESET_TIMER, 0, 0);
              // request timer value
              mcpha_send(MCPHA_COMMAND_GET_TIMER, 0, 0);
            } else if (tab === "mca-2") {
              // Reset timer
              mcpha_send(MCPHA_COMMAND_RESET_TIMER, 1, 0);
              // request timer value
              mcpha_send(MCPHA_COMMAND_GET_TIMER, 1, 0);
            }
          });

          // clear data button click handler
          $('#cleardata').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            var ch = (tab === "mca-1") ? 0 : (tab === "mca-2") ? 1 : -1;
            if (ch !== -1) {
              // Reset histogram
              mcpha_send(MCPHA_COMMAND_RESET_HISTOGRAM, ch, 0);
              // Reset timer
              mcpha_send(MCPHA_COMMAND_RESET_TIMER, ch, 0);
              // request timer value
              mcpha_send(MCPHA_COMMAND_GET_TIMER, ch, 0);
              // request histogram
              mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA, ch, 0);
            }
          });

          // Linear/Log Y scale button click handlers
          $('#linscale').on('click', function (e) {
            set_yscale("lin");
            update_chart();
          });
          $('#logscale').on('click', function (e) {
            set_yscale("log");
            update_chart();
          });

          // Download button click handler and modal setup
          $('.modal').modal({
            dismissible: true,                // Modal can be dismissed by clicking outside of the modal
            opacity: .5,                      // Opacity of modal background
            inDuration: 300,                  // Transition in duration
            outDuration: 200,                 // Transition out duration
            startingTop: '4%',                // Starting top style attribute
            endingTop: '10%',                 // Ending top style attribute
            ready: function(modal, trigger) { // Callback for Modal open. Modal and trigger parameters available.
              // retrieve previous data file metadata
              var datafile, samdesc, detdesc, dataformat;
              var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
              if (tab === "mca-1") {
                datafile = localStorage.getItem(MCPHA_MCA_1_DATAFILE);
                if (datafile === null) {
                  datafile = "mca1-data";
                }
                dataformat = localStorage.getItem(MCPHA_MCA_1_DATAFORMAT);
                if (dataformat === null) {
                  dataformat = "plain-txt";
                }
                samdesc = localStorage.getItem(MCPHA_MCA_1_SAMDESC);
                if (samdesc === null) {
                  samdesc = "";
                }
                detdesc = localStorage.getItem(MCPHA_MCA_1_DETDESC);
                if (detdesc === null) {
                  detdesc = "";
                }
              } else if (tab === "mca-2") {
                datafile = localStorage.getItem(MCPHA_MCA_2_DATAFILE);
                if (datafile === null) {
                  datafile = "mca2-data";
                }
                dataformat = localStorage.getItem(MCPHA_MCA_2_DATAFORMAT);
                if (dataformat === null) {
                  dataformat = "plain-txt";
                }
                samdesc = localStorage.getItem(MCPHA_MCA_2_SAMDESC);
                if (samdesc === null) {
                  samdesc = "";
                }
                detdesc = localStorage.getItem(MCPHA_MCA_2_DETDESC);
                if (detdesc === null) {
                  detdesc = "";
                }
              }
              $('#'+MCPHA_MCA_DATAFORMAT).val(dataformat);
              $('#'+MCPHA_MCA_DATAFORMAT).material_select();
              $('#'+MCPHA_MCA_DATAFILE).val(datafile);
              $('#'+MCPHA_MCA_SAMPLE_DESC).val(samdesc);
              $('#'+MCPHA_MCA_DETECTOR_DESC).val(detdesc);
              Materialize.updateTextFields();
            },
            complete: function() {
              // Callback for Modal close
            } 
          });
          // Whats to be done when the download button is pressed
          $('#download_agree').on('click', function (e) {
            var datafile, samdesc, detdesc, dataformat, data = null;
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === "mca-1") {
              // get data file format
              dataformat = $('#'+MCPHA_MCA_DATAFORMAT).val();
              localStorage.setItem(MCPHA_MCA_1_DATAFORMAT, dataformat);
              // get data filename
              datafile = $('#'+MCPHA_MCA_DATAFILE).val();
              localStorage.setItem(MCPHA_MCA_1_DATAFILE, datafile);
              // get sample description
              samdesc = $('#'+MCPHA_MCA_SAMPLE_DESC).val();
              localStorage.setItem(MCPHA_MCA_1_SAMDESC, samdesc);
              // get detector desc
              detdesc = $('#'+MCPHA_MCA_DETECTOR_DESC).val();
              localStorage.setItem(MCPHA_MCA_1_DETDESC, detdesc);
              //
console.log("dataformat="+dataformat+",samdesc="+samdesc+",detdesc="+detdesc+",datafile="+datafile);
              data = dump_mca_data(mca1_data, mca1_rois, dataformat, 1,
                                   acqdat[0], samdesc, detdesc, datafile);
            } else if (tab === "mca-2") {
              // get data file format
              dataformat = $('#'+MCPHA_MCA_DATAFORMAT).val();
              localStorage.setItem(MCPHA_MCA_2_DATAFORMAT, dataformat);
              // get data filename
              datafile = $('#'+MCPHA_MCA_DATAFILE).val();
              localStorage.setItem(MCPHA_MCA_2_DATAFILE, datafile);
              // get sample description
              samdesc = $('#'+MCPHA_MCA_SAMPLE_DESC).val();
              localStorage.setItem(MCPHA_MCA_2_SAMDESC, samdesc);
              // get detector desc
              detdesc = $('#'+MCPHA_MCA_DETECTOR_DESC).val();
              localStorage.setItem(MCPHA_MCA_2_DETDESC, detdesc);
              //
              data = dump_mca_data(mca2_data, mca2_rois, dataformat, 2,
                                   acqdat[1], samdesc, detdesc, datafile);
            }
            if (data !== null) {
              download(data.payload, data.file, "application/octet-stream");
              log_status_message("Download complete.", true);
            }
          });
          $('#download').on('click', function (e) {
            $('#m1').modal('open');
          });

          // zoom IN button clicked
          $('#zoomin').on('click', function (e) {
            set_cursor_mode(CURSOR_MODE_ZOOMIN);
          });

          // zoom OUT button clicked
          $('#zoomout').on('click', function (e) {
            set_cursor_mode(CURSOR_MODE_ZOOMOUT);
          });

          // Full extent button clicked
          $("#fullextent").click(function () {
            var axis = chart.getAxes();
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === 'mca-1') {
              mca1_options.xaxis.min = axis.xaxis.datamin;
              mca1_options.xaxis.max = Math.ceil(axis.xaxis.datamax);
              mca1_options.yaxis.min = 0;
              mca1_options.yaxis.max = Math.ceil(axis.yaxis.datamax);
              mca1_options.xaxis.tickSize = get_zoom_ticks(mca1_options.xaxis.min, mca1_options.xaxis.max, mca1_options);
              update_chart();
              set_cursor_mode(CURSOR_MODE_CLEAR_ALL);
            } else if (tab === 'mca-2') {
              mca2_options.xaxis.min = axis.xaxis.datamin;
              mca2_options.xaxis.max = Math.ceil(axis.xaxis.datamax);
              mca2_options.yaxis.min = 0;
              mca2_options.yaxis.max = Math.ceil(axis.yaxis.datamax);
              mca2_options.xaxis.tickSize = get_zoom_ticks(mca2_options.xaxis.min, mca2_options.xaxis.max, mca2_options);
              update_chart();
              set_cursor_mode(CURSOR_MODE_CLEAR_ALL);
            }
          });

          // ROI 1 button
          $('#roi1').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if ((tab === "mca-1" && mca1_acq) || (tab === "mca-2" && mca2_acq)) {
              log_status_message("Cannot set ROI region while acquiring spectrum.", true);
              return;
            } else {
              set_cursor_mode(CURSOR_MODE_SETROI_1);
              update_chart();
            }
          });

          // ROI 2 button
          $('#roi2').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if ((tab === "mca-1" && mca1_acq) || (tab === "mca-2" && mca2_acq)) {
              log_status_message("Cannot set ROI region while acquiring spectrum.", true);
              return;
            } else {
              set_cursor_mode(CURSOR_MODE_SETROI_2);
              update_chart();
            }
          });

          // ROI 3 button
          $('#roi3').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if ((tab === "mca-1" && mca1_acq) || (tab === "mca-2" && mca2_acq)) {
              log_status_message("Cannot set ROI region while acquiring spectrum.", true);
              return;
            } else {
              set_cursor_mode(CURSOR_MODE_SETROI_3);
              update_chart();
            }
          });

          // Clear ROI's button
          $('#roi_clearall').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if ((tab === "mca-1" && mca1_acq) || (tab === "mca-2" && mca2_acq)) {
              log_status_message("Cannot clear ROI region's while acquiring spectrum.", true);
              return;
            } else {
              set_cursor_mode(CURSOR_MODE_CLEAR_ROIS);
              update_chart();
            }
          });
          
          $('#getoscdata').on('click', function (e) {
            if (osc_acq) {
              osc_acq = false;
            } else {
              // reset oscilloscope
              mcpha_send(MCPHA_COMMAND_RESET_OSCILLOSCOPE, 0, 0);
              // set whether mca channel 1 has negative input
              mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE, 0, localStorage.getItem(MCPHA_MCA_1_IN_NEG) === "true" ? 1 : 0);
              // set whether mca channel 2 has negative input
              mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE, 1, localStorage.getItem(MCPHA_MCA_2_IN_NEG) === "true" ? 1 : 0);
              // set trigger source
              if (localStorage.getItem(MCPHA_OSC_TRIG_SOURCE) === "1") {
                mcpha_send(MCPHA_COMMAND_SET_TRIGGER_SOURCE, 0, 0);
              } else {
                mcpha_send(MCPHA_COMMAND_SET_TRIGGER_SOURCE, 1, 0);
              }
              // set trigger mode
              if (localStorage.getItem(MCPHA_OSC_TRIG_MODE) === "n") {
                mcpha_send(MCPHA_COMMAND_SET_TRIGGER_MODE, 0, 0);
              } else {
                mcpha_send(MCPHA_COMMAND_SET_TRIGGER_MODE, 1, 0);
              }
              // set trigger edge
              if (localStorage.getItem(MCPHA_OSC_TRIG_EDGE) === "r") {
                mcpha_send(MCPHA_COMMAND_SET_TRIGGER_SLOPE, 0, 0);
              } else {
                mcpha_send(MCPHA_COMMAND_SET_TRIGGER_SLOPE, 1, 0);
              }
              // set trigger level
              mcpha_send(MCPHA_COMMAND_SET_TRIGGER_LEVEL, 0, parseInt(localStorage.getItem(MCPHA_OSC_TRIG_LEVEL)));
              // Set number of samples to skip before trigger
              mcpha_send(MCPHA_COMMAND_SET_NUMBER_OF_SAMPLES_BEFORE_TRIGGER, 0, 1000);
              // Set total number of samples to acquire for this run
              mcpha_send(MCPHA_COMMAND_SET_TOTAL_NUMBER_OF_SAMPLES_TO_ACQUIRE, 0, 65536);
              // Start oscilloscope aquisition
              osc_acq = true;
              mcpha_send(MCPHA_COMMAND_START_OSCILLOSCOPE, 0, 0);
              // set acquisition flag
              osc_acq = true;
              // get oscilloscope status
              mcpha_send(MCPHA_COMMAND_GET_OSCILLOSCOPE_STATUS, 0, 0);
            }
            update_osc_acquisition_buttons_text(osc_acq);
          });
        }

        //
        //
        //
        function init_keypress_handlers() {
          // Catch keypressess
          // left = 37, up = 38, right = 39, down = 40
          $(document).keyup(function (e) {
            if (e.which === 37) {
              var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
              if (tab === "mca-1") {
                update_cursor_pos(mca1_cursor, -1);
              } else if (tab === "mca-2") {
                update_cursor_pos(mca2_cursor, -1);
              }
            } else if (e.which === 38) {
              if (!auto_y_scale) {
                adjust_vertical_scale_and_update(+1);
              }
            } else if (e.which === 39) {
              var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
              if (tab === "mca-1") {
                update_cursor_pos(mca1_cursor, 1);
              } else if (tab === "mca-2") {
                update_cursor_pos(mca2_cursor, 1);
              }
            } else if (e.which === 40) {
              if (!auto_y_scale) {
                adjust_vertical_scale_and_update(-1);
              }
            } else if (e.which === 13) {
            }
          });
        }

        // initialise device connection status indicator
        update_device_connection_indicator(WEBSOCKET_DISCONNECTED);

        // install settings update handlers
        init_settings_handlers();

        // install tool handlers
        init_tool_handlers();

        // init chart handlers
        init_chart_handlers();

        // install keypress handlers
        init_keypress_handlers();

        //
        // Install sidebar menu click handler to show/hide sidebar menu
        //
        $('#sidebar').on('click', function () {
          toggle_sidebar();
        });

        $('select').material_select();

        // initialise sidebar
        init_sidebar();

        // initialise tabs
        init_tabs();

        // hide busy indicator
        show_busy_indicator(false);

        // if device connection button is on then
        // try and establish a connection now.
        if ($('#' + MCPHA_CONNECT_DEVICE).prop('checked')) {
          wsock = init_websocket(wsock);
        }
        
        // initialisation complete
        init_complete = true;

        // install browser window resize handler
        window.addEventListener('resize', resize_handler);
        // resize chart to fit browser window
        resize_chart_div();

        // ok ready now
        log_status_message("Ready", true);
      });
    </script>

    <!-- Start of busy indicator section -->
    <div id="loader-wrapper">
      <div id="loader"></div>
      <div class="loader-section section-left"></div>
      <div class="loader-section section-right"></div>
    </div>
    <!-- End of busy indicator section -->
    
    <!-- MCA data download modal section -->
    <div id="m1" class="modal">
      <div class="modal-content">
        <h5>Download MCA data</h5>
        <div class="row">
          <form class="col s12">
            <div class="row modal-form-row">
              <div class="input-field col s8">
                <input id="mcpha_mca_datafile" type="text" class="validate">
                <label for="mcpha_mca_datafile">Filename</label>
              </div>
              <div class="input-field col s4">
                <select id="mcpha_mca_dataformat">
                  <option selected value="plain-txt">Plain Text File</option>
                  <option value="json-txt">JSON Text File</option>
                  <option value="ortec-chn">Ortec Maestro Chn</option>
                </select>
                <label for="mcpha_mca_dataformat">Download Data Format</label>
              </div>
            </div>
            <div class="row modal-form-row">
              <div class="input-field col s6">
                <input id="mcpha_mca_sample_desc" type="text" class="validate">
                <label for="mcpha_mca_sample_desc">Sample description</label>
              </div>
              <div class="input-field col s6">
                <input id="mcpha_mca_detector_desc" type="text" class="validate">
                <label for="mcpha_mca_detector_desc">Detector description</label>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer brown darken-2">
        <a id="download_agree" class=" modal-action modal-close waves-effect waves-green btn-flat orange lighten-4">Download</a>
      </div>
    </div>
    <!-- End of MCA data download modal section -->
    
    <!-- Start of ROI dropdown section -->
    <ul id='roidd' class='dropdown-content collection'>
      <li id="roi1_container" class="orange lighten-4" style="height: 20px; display:flex"><a id="roi1" href="#!">ROI #1  <span class="badge right"></span></a><i id="roi1_clear" class="material-icons right">delete</i></li>
      <li id="roi2_container" class="orange lighten-4" style="height: 20px; display:flex"><a id="roi2" href="#!">ROI #2  <span class="badge right"></span></a><i id="roi2_clear" class="material-icons right">delete</i></li>
      <li id="roi3_container" class="orange lighten-4" style="height: 20px; display:flex"><a id="roi3" href="#!">ROI #3  <span class="badge right"></span></a><i id="roi3_clear" class="material-icons right">delete</i></li>
      <li class="divider"></li>
      <li><a id="roi_clearall" class="orange lighten-5" href="#!">Clear All ROI's</a></li>
    </ul>
    <!-- End of ROI dropdown section -->
    
    <header>
      <nav>
        <div class="nav-wrapper brown darken-2">
          <a id="sidebar" href="#"><i class="left large material-icons">menu</i></a>
          <div class="logo-pos brand-logo">MCPHA Client</div>
          <ul class="right">
            <li><a  id="mca-1" class="waves-effect waves-light btn orange lighten-4 selectedtab">MCA 1</a></li>
            <li><a id="mca-2" class="waves-effect waves-light btn orange lighten-4">MCA 2</a></li>
            <li><a id="osc" class="waves-effect waves-light btn orange lighten-4">Oscilloscope</a></li>
            <li><a id="log" class="waves-effect waves-light btn orange lighten-4">Log</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <main>
      <div class="root-container">
        <div id="slide-menu" class="side-nav">
          <h5>General Settings</h5>
          <form>
            <div class="valign-wrapper">
              <div class="s6 input-field">
                <label>Device IP Address[:port]</label>
                <input type="text" id="mcpha_device_addr" value="0.0.0.0">
              </div>
              <div class="switch s6">
                <label class="right valign">
                  <input type="checkbox" id="mcpha_connect_device">
                  <span class="lever"></span>
                </label>
              </div>
            </div>
            <div class="valign-wrapper">
              <div class="s6 input-field">
                <label>LLD</label>
                <input type="text" id="mcpha_mca_lld" value="300">
              </div>
              <div class="s6 input-field right">
                <label>ULD</label>
                <input type="text" id="mcpha_mca_uld" value="16300">
              </div>
            </div>
            <div class="switch">
              <label class="left">Auto Y scale</label>
              <label class="right">
                <input type="checkbox" id="mcpha_mca_auto_y_scale">
                <span class="lever"></span>
              </label>
            </div>
            <br/>
            <div class="input-field">
              <label>Decimation Factor</label>
              <input type="number" step="4" id="mcpha_dec_factor" value="4">
            </div>
          </form>
          <div id="mca-1-sidebar">
            <h5>MCA 1 Settings</h5>
            <form action="#">
              <div class="switch">
                <label class="left">Negative Input</label>
                <label class="right">
                  <input type="checkbox" id="mcpha_mca_1_in_neg" checked="checked">
                  <span class="lever"></span>
                </label>
              </div>
              <br/>
              <div class="input-field">
                <label>Acquisition Time (seconds)</label>
                <input type="number" step="1" id="mcpha_mca_1_acq_time" value="60">
              </div>
              <div class="input-field">
                <select id="mcpha_mca_1_trig_mode">
                  <option selected value="n">Normal</option>
                  <option value="a">Automatic</option>
                </select>
                <label>Trigger Mode</label>
              </div>
              <div class="input-field">
                <select id="mcpha_mca_1_trig_source">
                  <option selected value="1">Channel 1</option>
                  <option value="2">Channel 2</option>
                </select>
                <label>Trigger Source</label>
              </div>
              <div class="input-field">
                <select id="mcpha_mca_1_trig_edge">
                  <option selected value="r">Rising  _/¯</option>
                  <option value="f">Falling  ¯\_</option>
                </select>
                <label>Trigger Edge</label>
              </div>
              <div class="input-field">
                <label>Trigger Level</label>
                <input type="number" id="mcpha_mca_1_trig_level" step="5" value="200">
              </div>
            </form>
          </div>
          <div id="mca-2-sidebar">
            <h5>MCA 2 Settings</h5>
            <form action="#">
              <div class="switch">
                <label class="left">Negative Input</label>
                <label class="right">
                  <input type="checkbox" id="mcpha_mca_2_in_neg" checked="checked">
                  <span class="lever"></span>
                </label>
              </div>
              <br/>
              <div class="input-field">
                <label>Acquisition Time (seconds)</label>
                <input type="number" step="1" id="mcpha_mca_2_acq_time" value="60">
              </div>
              <div class="input-field">
                <select id="mcpha_mca_2_trig_mode">
                  <option selected value="n">Normal</option>
                  <option value="a">Automatic</option>
                </select>
                <label>Trigger Mode</label>
              </div>
              <div class="input-field">
                <select id="mcpha_mca_2_trig_source">
                  <option value="1">Channel 1</option>
                  <option selected value="2">Channel 2</option>
                </select>
                <label>Trigger Source</label>
              </div>
              <div class="input-field">
                <select id="mcpha_mca_2_trig_edge">
                  <option selected value="r">Rising  _/¯</option>
                  <option value="f">Falling  ¯\_</option>
                </select>
                <label>Trigger Edge</label>
              </div>
              <div class="input-field">
                <label>Trigger Level</label>
                <input type="number" id="mcpha_mca_2_trig_level" step="5" value="200">
              </div>
            </form>
          </div>
          <div id="osc-sidebar">
            <h5>Oscilloscope Settings</h5>
            <form action="#">
              <div class="switch switch-row-spacing">
                <label class="left">Channel 1</label>
                <label class="right">
                  <input type="checkbox" id="mcpha_osc_1_in" checked="checked">
                  <span class="lever"></span>
                </label>
              </div>
              <br/><br/>
              <div class="switch switch-row-spacing">
                <label class="left">Channel 2</label>
                <label class="right">
                  <input type="checkbox" id="mcpha_osc_2_in" checked="checked">
                  <span class="lever"></span>
                </label>
              </div>
              <br/><br/>
              <div class="input-field">
                <select id="mcpha_osc_trig_mode">
                  <option selected value="n">Normal</option>
                  <option value="a">Automatic</option>
                </select>
                <label>Trigger Mode</label>
              </div>
              <div class="input-field">
                <select id="mcpha_osc_trig_source">
                  <option selected value="1">Channel 1</option>
                  <option value="2">Channel 2</option>
                </select>
                <label>Trigger Source</label>
              </div>
              <div class="input-field">
                <select id="mcpha_osc_trig_edge">
                  <option selected value="r">Rising  _/¯</option>
                  <option value="f">Falling  ¯\_</option>
                </select>
                <label>Trigger Edge</label>
              </div>
              <div class="input-field">
                <label>Trigger Level</label>
                <input type="number" id="mcpha_osc_trig_level" step="5" value="200">
              </div>
            </form>
          </div>
          <div id="log-sidebar">
            <h5>Log Settings</h5>
            <form action="#">
            </form>
          </div>
        </div>
        <div id="slide-body" class="side-body">
          <nav class="gray spacer10 no-shadow">
            <div id="mca-toolbar">
              <div class="left">
                <a id="enableacq" class="btn waves-effect waves-light orange lighten-4 disabled" title="Set/Stop data acquisition"><i style="line-height:inherit" class="material-icons right">play_arrow</i>Start</a>
                <a id="cleartimer" class="waves-effect waves-light btn icon-btn orange lighten-4 disabled" title="Clear acquisition time"><i style="line-height:inherit" class="material-icons center">restore</i></a>
                <a id="cleardata" class="waves-effect waves-light btn icon-btn orange lighten-4 disabled" title="Clear acquisition data and time"><i style="line-height:inherit" class="material-icons center">delete</i></a>
              </div>
              <div class="right">
                  <!--
                  <a id="roi1" class="btn icon-text-btn waves-effect waves-light orange lighten-4 disabled" title="Set ROI #1"><i style="line-height:inherit" class="material-icons right">looks_one</i>ROI</a>
                  <a id="roi2" class="btn icon-text-btn waves-effect waves-light orange lighten-4 disabled" title="Set ROI #2"><i style="line-height:inherit" class="material-icons right">looks_two</i>ROI</a>
                  <a id="roi3" class="btn icon-text-btn waves-effect waves-light orange lighten-4 disabled" data-activates="roidd" title="Set ROI #3"><i style="line-height:inherit" class="material-icons right">looks_3</i>ROI</a>
                  -->
                  <a id="rois" class="dropdown-button btn icon-btn waves-effect waves-light orange lighten-4 disabled" data-activates="roidd" data-beloworigin="true" title="Set ROI's">ROI</a>
                  <div style="width: 10px; display:inline-block"></div>
                  <a id="fullextent" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Full extent"><i style="line-height:inherit" class="material-icons center">aspect_ratio</i></a>
                  <a id="zoomin" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Full extent"><i style="line-height:inherit" class="material-icons">zoom_in</i></a>
                  <a id="zoomout" class="btn icon-btn  waves-effect waves-light orange lighten-4 disabled" title="Full extent"><i style="line-height:inherit" class="material-icons">zoom_out</i></a>
                  <a id="pan" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Full extent"><i style="line-height:inherit" class="material-icons">pan_tool</i></a>
                  <div style="width: 10px; display:inline-block"></div>
                  <a id="linscale" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Log scale">Lin</a>
                  <a id="logscale" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Linear scale">Log</a>
                  <div style="width: 10px; display:inline-block"></div>
                  <a id="download" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Download data"><i  style="line-height:inherit" class="material-icons">file_download</i></a>
              </div>
            </div>
            <div id="osc-toolbar">
              <div class="left">
                <a id="getoscdata" class="btn waves-effect waves-light orange lighten-4 disabled" title="Get oscilloscope data."><i style="line-height:inherit" class="material-icons right">play_arrow</i>Get Oscilloscope Data</a>
              </div>
            </div>
          </nav>
          <div id="mca-container">
            <div id="cursor-panel">
              Cursor ......... : <span id="cursor">0</span>
              Counts ......... : <span id="counts">0</span>
              Acq. Time (s) .. : <span id="acqtime_s"></span>
              Elapsed Time (s) : <span id="elapsedtime"></span>
              ROI #1 ......... : <span id="roi1_counts"></span>
              ROI #2 ......... : <span id="roi2_counts"></span>
              ROI #3 ......... : <span id="roi3_counts"></span>
            </div>
            <div id="mca-chart"></div>
          </div>
          <div id="osc-container">
            <div id="osc-chart"></div>
          </div>
          <div id="log-container">
            <div id="messages"></div>
          </div>
        </div>
      </div>
    </main>
        
    <footer class="page-footer brown darken-2">
      <div>
        <div class="right">
          <div class="net-traffic brown-text lighten-4" title="Network traffic."><i id="net-traffic" class="small material-icons flash animated">swap_horiz</i></div>
          <div class="device-connection"><i id="device-connection" class="small material-icons">signal_cellular_null</i></div>
        </div>
      </div>
    </footer>
  </body>
</html>