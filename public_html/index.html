<!DOCTYPE html>
<!--
Copyright 2017 John Preston<byhisdeeds@gmail.com> NURAS.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
    <title>MCPHA Client</title>

    <link rel='shortcut icon' type='image/x-icon' href='favicon.ico' />

    <!-- CSS  -->
    <link href="css/material-icons.css" rel="stylesheet">
    <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen"/>
    <link href="css/style.css" type="text/css" rel="stylesheet" media="screen"/>
  </head>
  <body>
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
    <script type="text/javascript" src="js/jquery.multilevelpushmenu.min.js"></script>
    <script type="text/javascript" src="js/long.js"></script>
    <script type="text/javascript" src="js/jquery.flot.min.js"></script>
    <script type="text/javascript" src="js/jquery.flot.selection.min.js"></script>
    <script type="text/javascript" src="js/download.js"></script>

    <script type="text/javascript">
      const START_ACQUISITION_TEXT = "<i style='line-height:inherit' class='material-icons right'>play_arrow</i>Start";
      const STOP_ACQUISITION_TEXT = "<i style='line-height:inherit' class='material-icons right'>stop</i>Stop";
      
      const DEVICE_CONNECTION = "device-connection";

      const MCPHA_SIDEBAR_OPEN = "mcpha_sidebar_open";
      const MCPHA_SELECTED_TAB = "mcpha_selected_tab";
      const MCPHA_DEC_FACTOR = "mcpha_dec_factor";
      const MCPHA_DEVICE_ADDR = "mcpha_device_addr";
      const MCPHA_CONNECT_DEVICE = "mcpha_connect_device";
      const MCPHA_MCA_1_IN_NEG = "mcpha_mca_1_in_neg";
      const MCPHA_MCA_1_ACQ_TIME = "mcpha_mca_1_acq_time";
      const MCPHA_MCA_1_TRIG_MODE = "mcpha_mca_1_trig_mode";
      const MCPHA_MCA_1_TRIG_SOURCE = "mcpha_mca_1_trig_source";
      const MCPHA_MCA_1_TRIG_EDGE = "mcpha_mca_1_trig_edge";
      const MCPHA_MCA_1_TRIG_LEVEL = "mcpha_mca_1_trig_level";
      const MCPHA_MCA_2_IN_NEG = "mcpha_mca_2_in_neg";
      const MCPHA_MCA_2_ACQ_TIME = "mcpha_mca_2_acq_time";
      const MCPHA_MCA_2_TRIG_MODE = "mcpha_mca_2_trig_mode";
      const MCPHA_MCA_2_TRIG_SOURCE = "mcpha_mca_2_trig_source";
      const MCPHA_MCA_2_TRIG_EDGE = "mcpha_mca_2_trig_edge";
      const MCPHA_MCA_2_TRIG_LEVEL = "mcpha_mca_2_trig_level";
      const MCPHA_OSC_1_IN = "mcpha_osc_1_in";
      const MCPHA_OSC_1_IN_NEG = "mcpha_osc_1_in_neg";
      const MCPHA_OSC_2_IN = "mcpha_osc_2_in";
      const MCPHA_OSC_2_IN_NEG = "mcpha_osc_2_in_neg";
      const MCPHA_OSC_TRIG_MODE = "mcpha_osc_trig_mode";
      const MCPHA_OSC_TRIG_SOURCE = "mcpha_osc_trig_source";
      const MCPHA_OSC_TRIG_EDGE = "mcpha_osc_trig_edge";
      const MCPHA_OSC_TRIG_LEVEL = "mcpha_osc_trig_level";
      const MCPHA_MCA_DATA_FORMAT = "mcpha_mca_data_format";
      const MCPHA_MCA_LLD = "mcpha_mca_lld";
      const MCPHA_MCA_ULD = "mcpha_mca_uld";
      const TOAST_DELAY = 4000;
      const WEBSOCKET_CONNECTED = 1;
      const WEBSOCKET_CONNECTING = 2;
      const WEBSOCKET_DISCONNECTED = 3;
      const WEBSOCKET_ERROR = 4;

      const TIMER_FREQ = 125000000.0;
      const TIME_PER_TICK = 1.0 / TIMER_FREQ;
      const SHIFT_CODE = 56;
      const SHIFT_CHAN = 52;
      const MCPHA_COMMAND_RESET_TIMER = 0;
      const MCPHA_COMMAND_RESET_HISTOGRAM = 1;
      const MCPHA_COMMAND_RESET_OSCILLOSCOPE = 2;
      const MCPHA_COMMAND_RESET_GENERATOR = 3;
      const MCPHA_COMMAND_SET_SAMPLE_RATE = 4;
      const MCPHA_COMMAND_SET_NEGATOR_MODE = 5;
      const MCPHA_COMMAND_SET_BASELINE_MODE = 6;
      const MCPHA_COMMAND_SET_BASELINE_LEVEL = 7;
      const MCPHA_COMMAND_SET_PHA_DELAY = 8;
      const MCPHA_COMMAND_SET_PHA_MIN_THRESHOLD = 9;
      const MCPHA_COMMAND_SET_PHA_MAX_THRESHOLD = 10;
      const MCPHA_COMMAND_SET_TIMER_VALUE = 11;
      const MCPHA_COMMAND_SET_TIMER_MODE = 12;
      const MCPHA_COMMAND_GET_TIMER = 13;
      const MCPHA_COMMAND_GET_HISTOGRAM_DATA = 14;
      const MCPHA_COMMAND_SET_NUMBER_OF_SAMPLES_BEFORE_TRIGGER = 19;
      const MCPHA_COMMAND_SET_TOTAL_NUMBER_OF_SAMPLES_TO_ACQUIRE = 20;
      const MCPHA_COMMAND_START_OSCILLOSCOPE = 21;
      const MCPHA_COMMAND_GET_OSCILLOSCOPE_STATUS = 22;
      const MCPHA_COMMAND_GET_OSCILLOSCOPE_DATA = 23;

      const CURSOR_MODE_ZOOMIN = "zi";
      const CURSOR_MODE_ZOOMOUT = "zo";
      const CURSOR_MODE_PAN = "pan";
      const CURSOR_MODE_CLEAR_ALL = "";
      const CURSOR_MODE_SETROI_1 = "r1";
      const CURSOR_MODE_SETROI_2 = "r2";
      const CURSOR_MODE_SETROI_3 = "r3";


      // Returns a function, that, as long as it continues to be invoked, will not
      // be triggered. The function will be called after it stops being called for
      // N milliseconds. If `immediate` is passed, trigger the function on the
      // leading edge, instead of the trailing.
      function debounce(func, wait, immediate) {
        var timeout;
        return function () {
          var context = this, args = arguments;
          var later = function () {
            timeout = null;
            if (!immediate)
              func.apply(context, args);
          };
          var callNow = immediate && !timeout;
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
          if (callNow)
            func.apply(context, args);
        };
      }
      ;

      //
      //
      //
      function uint_8_to_base_64(u8Arr) {
        var CHUNK_SIZE = 0x8000; //arbitrary number
        var index = 0;
        var length = u8Arr.length;
        var result = '';
        var slice;
        while (index < length) {
          slice = u8Arr.subarray(index, Math.min(index + CHUNK_SIZE, length));
          result += String.fromCharCode.apply(null, slice);
          index += CHUNK_SIZE;
        }
        return btoa(result);
      }

      //
      //
      //
      function string_to_uint(string) {
        var string = btoa(unescape(encodeURIComponent(string))),
          charList = string.split(''), uintArray = [];
        for (var i = 0; i < charList.length; i++) {
          uintArray.push(charList[i].charCodeAt(0));
        }
        return new Uint8Array(uintArray);
      }


      $(function () {
        // websocket connection object
        var wsock = null;

        // Device connection status
        var devstatus = WEBSOCKET_DISCONNECTED;
        ;

        // MCA chartist and options
        var chart;
        var mca1_timer = null, mca1_acqtime = 0, mca2_timer = null, mca2_acqtime = 0;
        var mca1_data = [], mca1_options, mca1_cursor_mode, mca1_y_range = [[100, 500, 2000, 10000, 50000, 200000, 1000000], [0.1, 1, 10, 100, 1000, 10000]];
        var mca2_data = [], mca2_options, mca2_cursor_mode, mca2_y_range = [[100, 500, 2000, 10000, 50000, 200000, 1000000], [0.1, 1, 10, 100, 1000, 10000]];
        var osc_data = [], osc_options, osc_cursor_mode;
        var mca1_acq = false, mca2_acq = false;
        
        // window resized handler
        var resize_handler = debounce(function () {
          resize_chart_div();
        }, 400);


        //
        // Resize div element that chart is bound to
        //
        function resize_chart_div() {
          // resize mca chart to fill div
          var lpad = parseInt($("#mca-chart").css("padding-left"), 10);
          var rpad = parseInt($("#mca-chart").css("padding-right"), 10);
          var tpad = parseInt($("#mca-chart").css("padding-top"), 10);
          var bpad = parseInt($("#mca-chart").css("padding-bottom"), 10);
          var w = Math.floor($("#slide-body").width()) - (lpad + rpad); // less padding
          var h = Math.floor($("#slide-body").height()) - (tpad + bpad + 64); // less padding
          // regenerate the chart
          $("#mca-chart").width(w);
          $("#mca-chart").height(h);

          update_chart();
//          mca1_options.points.show = true;
//          mca1_options.grid.backgroundColor = "#fff";
//          
//          chart = $.plot("#mca-chart", [[0, 30], [400, 80], [800, 50], [9000, 90]], mca1_options);
        }

        //
        // Return a text string representing the device connection status
        //
        function devstatus_string(code) {
          return (code === WEBSOCKET_DISCONNECTED) ? "is disconnected" :
            (code === WEBSOCKET_CONNECTING) ? "is connecting" :
            (code === WEBSOCKET_CONNECTED) ? "is connected" :
            (code === WEBSOCKET_ERROR) ? "connection error" :
            "unknown";
        }

        //
        // Initialise device connection status indicator
        //
        function update_device_connection_indicator(code) {
          devstatus = code;
          // update the connection icon
          if (devstatus === WEBSOCKET_CONNECTING) {
            $("#" + DEVICE_CONNECTION).text("signal_cellular_null");
            $("#" + DEVICE_CONNECTION).css("color", "orange");
          } else if (devstatus === WEBSOCKET_CONNECTED) {
            $("#" + DEVICE_CONNECTION).text("signal_cellular_4_bar");
            $("#" + DEVICE_CONNECTION).css("color", "white");
          } else if (devstatus === WEBSOCKET_DISCONNECTED) {
            $("#" + DEVICE_CONNECTION).text("signal_cellular_null");
            $("#" + DEVICE_CONNECTION).css("color", "white");
          } else if (devstatus === WEBSOCKET_ERROR) {
            $("#" + DEVICE_CONNECTION).text("signal_cellular_connected_no_internet_4_bar");
            $("#" + DEVICE_CONNECTION).css("color", "deep orange");
          }
          // update the tooltip
          var p = localStorage.getItem(MCPHA_DEVICE_ADDR);
          $("#" + DEVICE_CONNECTION).prop("title", "Device " +
            devstatus_string(devstatus) +
            " (" + ((p !== null && p !== 'undefined') ? p : "0.0.0.0") +
            ")");
        }

        //
        // Initialise websocket connection
        //
        function init_websocket(ws) {
          if (ws !== null && ws.readyState === 1) {
            ws.close();
          }

          update_device_connection_indicator(WEBSOCKET_CONNECTING);

          var wsuri = "ws://" + localStorage.getItem(MCPHA_DEVICE_ADDR);
          ws = new WebSocket(wsuri);
          ws.binaryType = 'arraybuffer'; // default is 'blob'

          ws.onopen = function () {
            log_status_message('Websocket connection established.', true);
            update_device_connection_indicator(WEBSOCKET_CONNECTED);
            // initialise device state
            mcpha_send(MCPHA_COMMAND_SET_SAMPLE_RATE, 0, 4);
            mcpha_send(MCPHA_COMMAND_SET_PHA_DELAY, 0, 100);
            // if mca mode then get histogram data
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === "mca-1") {
              mcpha_send(MCPHA_COMMAND_SET_PHA_MIN_THRESHOLD, 0,
                parseInt(localStorage.getItem(MCPHA_MCA_LLD)));
              mcpha_send(MCPHA_COMMAND_SET_PHA_MAX_THRESHOLD, 0,
                parseInt(localStorage.getItem(MCPHA_MCA_ULD)));
              // set whether mca channel 1 has negative input
              mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE, 0,
                localStorage.getItem(MCPHA_MCA_1_IN_NEG) === " true" ? 1 : 0);
              // request timer value
              mcpha_send(MCPHA_COMMAND_GET_TIMER, 0, 0);
              // request histogram data
              mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA, 0, 0);
            } else if (tab === "mca-2") {
              mcpha_send(MCPHA_COMMAND_SET_PHA_MIN_THRESHOLD, 1,
                parseInt(localStorage.getItem(MCPHA_MCA_LLD)));
              mcpha_send(MCPHA_COMMAND_SET_PHA_MAX_THRESHOLD, 1,
                parseInt(localStorage.getItem(MCPHA_MCA_ULD)));
              // set whether mca channel 1 has negative input
              mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE, 1,
                localStorage.getItem(MCPHA_MCA_2_IN_NEG) === " true" ? 1 : 0);
              // request timer value
              mcpha_send(MCPHA_COMMAND_GET_TIMER, 1, 0);
              // request histogram data
              mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA, 1, 0);
            } else if (tab === "osc") {

            }
            // update toolbar buttons
            update_toolbar_buttons(true);
          };

          ws.onclose = function () {
            // if devstatus is not WEBSOCKET_ERROR
            // then we log the closed connection
            if (devstatus !== WEBSOCKET_ERROR) {
              log_status_message('Websocket connection closed.', true);
              devstatus = WEBSOCKET_DISCONNECTED;
            }
            // update toolbar buttons
            update_toolbar_buttons(false);
          };

          ws.onmessage = function (e) {
            if (e.data instanceof ArrayBuffer) {
              var r = new Uint32Array(e.data)[0];
              if (r === 0) {
                var data = new Uint32Array(e.data, 4);
                var timer1 = data[1] * 4294967296 + data[0];
                if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-1") {
                  $("#elapsedtime").text((timer1 / TIMER_FREQ).toFixed(1));
                }
                if (timer1 >= mca1_acqtime && mca1_timer !== null) {
                  clearInterval(mca1_timer);
                  mca1_acq = false;
                  update_mca_acquisition_buttons_text(mca1_acq);
                }
              } else if (r === 1) {
                var data = new Uint32Array(e.data, 4);
                var timer2 = data[1] * 4294967296 + data[0];
                console.log("timer2: ", timer2);
                if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-2") {
                  update_chart();
                }
              } else if (r === 2) {
                var data = new Uint32Array(e.data, 4);
                mca1_data.length = 0;
                for (let entry of data.entries()) {
                  mca1_data.push(entry);
                }
                if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-1") {
                  update_chart();
                }
              } else if (r === 3) {
                var data = new Uint32Array(evt.data, 4);
                mca2_data.length = 0;
                for (let entry of data.entries()) {
                  mca2_data.push(entry);
                }
                if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-2") {
                  update_chart();
                }
              } else if (r === 4) {
                var status = new Uint32Array(e.data, 4)[0];
                console.log("status: ", status);
              } else if (r === 5) {
                var data = new Uint16Array(e.data, 4);
                console.log("scope length: ", data.length);
                var chan1 = [];
                var chan2 = [];
                for (let entry of data.entries()) {
                  if (entry[0] % 2) {
                    entry[0] /= 2;
                    chan2.push(entry);
                  } else {
                    entry[0] /= 2;
                    chan1.push(entry);
                  }
                }
                //$.plot($("#placeholder"), [chan1, chan2]);
              }
            }
          };

          ws.onerror = function () {
            update_device_connection_indicator(WEBSOCKET_ERROR);
            log_status_message('Websocket error', true);
            // set connection button state
            localStorage.setItem(MCPHA_CONNECT_DEVICE, "off");
            $('#' + MCPHA_CONNECT_DEVICE).prop('checked', false);
            // disable toolbar buttons
            update_toolbar_buttons(false);
          };

          return ws;
        }

        //
        // Send commands to device
        //
        function mcpha_send(code, chan, data, func) {
          if (wsock !== null) {
            // send command
            var buffer = new ArrayBuffer(16);
            var dataInt = new Uint32Array(buffer);
            var dataFloat = new Float64Array(buffer, 8);

            dataInt[0] = code;
            dataInt[1] = chan;
            dataFloat[0] = data;
            wsock.send(buffer, {binary: true});
            console.log("code:" + code + ", chan:" + chan + ", data:" + data);
          }
        }

        //
        // Initial mca chart options
        //
        function default_mca_chart_options() {
          return {
            lines: {
              show: true,
              steps: true
            },
            points: {
              show: false
            },
            xaxis: {
              panRange: false,
              tickDecimals: 0,
              tickSize: 1000,
              min: 0,
              max: 16384,
              transform: function (x) {
                return x;
              }
            },
            yaxis: {
              panRange: false,
              labelWidth: 140,
              reserveSpace: true,
              position: "right",
              max: 100,
              min: 0,
              ticks: null, //[0.1,1,10,100,1000],
              transform: null//function(v) {
                //  return Math.log(v+0.0001); /*move away from zero*/
                //},
                //tickDecimals: 3,
                //tickFormatter: function (v, axis) {
                //  return "10" + (Math.round( Math.log(v)/Math.LN10)).toString().sup();
                //}
            },
            grid: {
              backgroundColor: "#999",
              hoverable: true,
              clickable: true,
              autoHighlight: false
            },
            crosshair: {
              mode: "x"
            },
            zoom: {
              interactive: true
            },
            pan: {
              interactive: false
            },
            selection: {
              mode: "x"
            }
          };
        }

        function init_chart_handlers() {
          // set initial elapsedtime
          $("#mca-chart").bind("plotclick", function (event, pos, item) {
            if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-1") {
              if (mca1_cursor_mode === CURSOR_MODE_ZOOMIN) {
                zoom_in_around_cursor_xpos(pos.x.toFixed(0), mca1_data, chart.getAxes(), mca1_options, true);
              } else if (mca1_cursor_mode === CURSOR_MODE_ZOOMOUT) {
                zoom_out_around_cursor_xpos(pos.x.toFixed(0), mca1_data, chart.getAxes(), mca1_options, true);
              }
            } else if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-2") {
              if (mca2_cursor_mode === CURSOR_MODE_ZOOMIN) {
                zoom_in_around_cursor_xpos(pos.x.toFixed(0), mca2_data, chart.getAxes(), mca2_options, true);
              } else if (mca2_cursor_mode === CURSOR_MODE_ZOOMOUT) {
                zoom_out_around_cursor_xpos(pos.x.toFixed(0), mca2_data, chart.getAxes(), mca2_options, true);
              }
            }
          });

          $("#mca-chart").bind("plothover", function (event, pos, item) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === "mca-1" || tab === "mca-2") {
              var cursor_mode = tab === "mca-1" ? mca1_cursor_mode : tab === "mca-2" ? mca2_cursor_mode : "";
              if (chart.getData().length > 0) {
                if (cursor_mode === CURSOR_MODE_ZOOMIN) {
                  $("#mca-chart").css("cursor", "url(css/images/zoom-in.ico) 9 9, auto", "important");
                } else if (cursor_mode === CURSOR_MODE_ZOOMOUT) {
                  $("#mca-chart").css("cursor", "url(css/images/zoom-out.ico) 9 9, auto", "important");
                } else if (cursor_mode === CURSOR_MODE_PAN) {
                  $("#mca-chart").css("cursor", "move", "important");
                } else if (cursor_mode === CURSOR_MODE_SETROI_1 || cursor_mode === CURSOR_MODE_SETROI_2 || cursor_mode !== CURSOR_MODE_SETROI_3) {
                  $("#mca-chart").css("cursor", "crosshair", "important");
                } else {
                  $("#mca-chart").css("cursor", "pointer", "important");
                }
                var x = pos.x.toFixed(0);
                if (x > 0 && x < chart.getData()[0].data.length) {
                  var y = chart.getData()[0].data[x][1];
                  $("#cursor").text(x);
                  $("#counts").text(y);
                }
              } else {
                $("#spectrum-placeholder").css("cursor", "pointer", "important");
              }
            }
          });

          //
          // ROI selection handler
          //
          $("#mca-chart").bind("plotselected", function (event, ranges) {
            console.log("roi selection - start:"+ranges.xaxis.from.toFixed(0)+" to "+ranges.xaxis.to.toFixed(0));
            /**
            if (roi2set !== "") {
              ws.send("{\"type\":\"req\",\"command\":\"set_roi\",\"roi\":"+
                      roi2set+",\"from\":"+ranges.xaxis.from.toFixed(0)+",\"to\":"+
                      ranges.xaxis.to.toFixed(0)+"}");
              $("#roi"+roi2set).removeClass("current-roi");
              plot.clearSelection();
            }
              ***/
             chart.clearSelection();
          });
        }

        //
        //
        //
        function zoom_in_around_cursor_xpos(xpos, data, axes, options, refresh) {
          if (data.length > 0) {
            // zoom in by a factor of 2
            var dmin = parseInt(axes.xaxis.datamin);
            var dmax = parseInt(axes.xaxis.datamax);
            var xmin = parseInt(options.xaxis.min);
            var xmax = parseInt(options.xaxis.max);
            var xrng = (xmax - xmin) / 2;
            if (xrng > 100) {
              xrng /= 2;
              xmin += (parseInt(xpos) - xmin) / 2;
              xmax -= (xmax - parseInt(xpos)) / 2;
              if (xmin < dmin) {
                xmin = dmin;
                xmax = xmin + (xrng * 2);
              } else if (xmax > dmax) {
                xmax = dmax;
                xmin = xmax - (xrng * 2);
              }
              options.xaxis.min = xmin;
              options.xaxis.max = xmax;
              options.xaxis.tickSize = get_zoom_ticks(xmin, xmax, options);
              console.log("options:" + options.toString());
              if (refresh) {
                update_chart();
              }
            }
          }
        }

        //
        //
        //
        function zoom_out_around_cursor_xpos(xpos, data, axes, options, refresh) {
          if (data.length > 0) {
            // zoom out by a factor of 2
            var dmin = parseInt(axes.xaxis.datamin);
            var dmax = parseInt(axes.xaxis.datamax);
            var xmin = parseInt(options.xaxis.min);
            var xmax = parseInt(options.xaxis.max);
            var xrng = xmax - xmin;
            if (xrng * 2 > (dmax - dmin)) {
              xmin = dmin;
              xmax = dmax;
            } else {
              xmin -= xrng;
              xmax += xrng;
              if (xmin < dmin) {
                xmin = dmin;
                xmax = xmin + (xrng * 2);
              } else if (xmax > dmax) {
                xmax = dmax;
                xmin = xmax - (xrng * 2);
              }
            }
            options.xaxis.min = xmin;
            options.xaxis.max = xmax;
            options.xaxis.tickSize = get_zoom_ticks(xmin, xmax, options);
            console.log("options:" + options.toString());
            if (refresh) {
              update_chart();
            }
          }
        }

        //
        //
        //
        function get_zoom_ticks(xmin, xmax, options) {
          if (options.yaxis.transform === null) {
            var xrng = xmax - xmin;
            if (xrng < 100) {
              t = 10;
            } else if (xrng < 500) {
              t = 50;
            } else if (xrng < 1000) {
              t = 100;
            } else if (xrng < 2000) {
              t = 200;
            } else if (xrng < 5000) {
              t = 500;
            } else if (xrng < 10000) {
              t = 1000;
            } else {
              t = 1000;
            }
            return t;
          } else {
            return 0;
          }
        }


        //
        //
        //
        function adjust_vertical_scale_and_update(adjustment) {
          if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-1") {
            adjust_vertical_scale(mca1_options, mca1_y_range, adjustment);
          } else if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-2") {
            adjust_vertical_scale(mca2_options, mca2_y_range, adjustment);
          }

          update_chart();
        }

        //
        //
        //
        function adjust_vertical_scale(options, y_range, adjustment) {
          if (options.yaxis.transform === null) { // Linear y scale
            if (adjustment > 0) {
              for (var i = 0, l = y_range[0].length - 1; i < l; i++) {
                if (options.yaxis.max <= y_range[0][i]) {
                  options.yaxis.max = y_range[0][i + 1];
                  break;
                }
              }
            } else if (adjustment < 0) {
              for (var i = y_range[0].length - 1; i > 0; i--) {
                if (options.yaxis.max >= y_range[0][i]) {
                  options.yaxis.max = y_range[0][i - 1];
                  break;
                }
              }
            }
          } else { // Log y scale
            if (adjustment > 0) {
              for (var i = 0, l = y_range[1].length - 1; i < l; i++) {
                if (options.yaxis.max <= y_range[1][i]) {
                  options.yaxis.max = y_range[1][i + 1];
                  break;
                }
              }
            } else if (adjustment < 0) {
              for (var i = y_range[1].length - 1; i > 0; i--) {
                if (options.yaxis.max >= y_range[1][i]) {
                  options.yaxis.max = y_range[1][i - 1];
                  break;
                }
              }
            }
          }
        }

        //
        //
        //
        function set_cursor_mode(mode) {
          console.log("set cursor mode:" + mode);
          if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-1") {
            mca1_cursor_mode = set_cursor_mode_options(mode, mca1_options, mca1_cursor_mode);
          } else if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-2") {
            mca2_cursor_mode, set_cursor_mode_options(mode, mca2_options, mca2_cursor_mode);
          } else if (localStorage.getItem(MCPHA_SELECTED_TAB) === "osc") {
            osc_cursor_mode = set_cursor_mode_options(mode, osc_options, osc_cursor_mode);
          }
        }

        //
        //
        //
        function set_cursor_mode_options(mode, options, current_mode) {
          $("#zoomin").removeClass("darken-2");
          if (mode === CURSOR_MODE_ZOOMIN) {
            if (current_mode === mode) {
              $("#zoomin").removeClass("darken-2");
              log_status_message("ZOOM mode OFF", true);
              return CURSOR_MODE_CLEAR_ALL;
            } else {
              $("#zoomout").removeClass("darken-2");
              $("#zoomin").addClass("darken-2");
              log_status_message("ZOOM mode IN", true);
              return mode;
            }
          } else if (mode === CURSOR_MODE_ZOOMOUT) {
            if (current_mode === mode) {
              $("#zoomout").removeClass("darken-2");
              log_status_message("ZOOM mode OFF", true);
              return CURSOR_MODE_CLEAR_ALL;
            } else {
              $("#zoomin").removeClass("darken-2");
              $("#zoomout").addClass("darken-2");
              log_status_message("ZOOM mode OUT", true);
              return mode;
            }
          } else if (mode === CURSOR_MODE_SETROI_1) {
            if (current_mode === mode) {
              $("#roi1").removeClass("darken-2");
              log_status_message("Set ROI #1 mode OFF", true);
              return CURSOR_MODE_CLEAR_ALL;
            } else {
              $("#roi2").removeClass("darken-2");
              $("#roi3").removeClass("darken-2");
              $("#roi1").addClass("darken-2");
              log_status_message("Set ROI #1 mode ON", true);
              return mode;
            }
          } else if (mode === CURSOR_MODE_SETROI_2) {
            if (current_mode === mode) {
              $("#roi2").removeClass("darken-2");
              log_status_message("Set ROI #2 mode OFF", true);
              return CURSOR_MODE_CLEAR_ALL;
            } else {
              $("#roi1").removeClass("darken-2");
              $("#roi3").removeClass("darken-2");
              $("#roi2").addClass("darken-2");
              log_status_message("Set ROI #2 mode ON", true);
              return mode;
            }
          } else if (mode === CURSOR_MODE_SETROI_3) {
            if (current_mode === mode) {
              $("#roi3").removeClass("darken-2");
              log_status_message("Set ROI #1 mode OFF", true);
              return CURSOR_MODE_CLEAR_ALL;
            } else {
              $("#roi1").removeClass("darken-2");
              $("#roi2").removeClass("darken-2");
              $("#roi3").addClass("darken-2");
              log_status_message("Set ROI #3 mode ON", true);
              return mode;
            }
          } else if (mode === "cleartimer") {
            ////////////////////////////////////////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////////////////
            // first clear any roiset modes
            if (roi2set !== "") {
              $("#roi" + roi2set).removeClass("current-roi");
              roi2set = "";
              options.selection.mode = null;
              replot(options);
            }
            // now clear any zoomin mode
            if (zoom_mode !== "") {
              $("button.zoom-in-button").removeClass("current-zoom");
              zoom_mode = "";
            }
            // now clear pan button
            if (pan_mode !== "") {
              $("button.pan-button").removeClass("current-zoom");
              pan_mode = "";
              options.pan.interactive = false;
              replot(options);
            }
          } else if (mode === "pan") {
            // first clear any roiset modes
            if (roi2set !== "") {
              $("#roi" + roi2set).removeClass("current-roi");
              roi2set = "";
              options.selection.mode = null;
            }
            // now clear any zoomin mode
            if (zoom_mode !== "") {
              $("button.zoom-in-button").removeClass("current-zoom");
              zoom_mode = "";
            }
            // now set pan mode
            $("button.pan-button").addClass("current-zoom");
            pan_mode = "pan";
            options.pan.interactive = true;
            replot(options);
            $.notify("Pan spectrum region using mouse.", "info");
          } else if (mode === "zoomin") {
            // first clear any roiset modes
            if (roi2set !== "") {
              $("#roi" + roi2set).removeClass("current-roi");
              roi2set = "";
              options.selection.mode = null;
              replot(options);
            }
            // now clear pan button
            if (pan_mode !== "") {
              $("button.pan-button").removeClass("current-zoom");
              pan_mode = "";
              options.pan.interactive = false;
              replot(options);
            }
            // now set zoomin mode
            if (zoom_mode === "") {
              $("button.zoom-in-button").addClass("current-zoom");
              zoom_mode = mode;
            }
            $.notify("Select spectrum region using mouse.", "info");
          } else if (mode === "roi2set") {
            if (acquiring) {
              $.notify("Cannot set ROI while acquiring spectra.", "info");
            } else {
              // first clear any zoomin mode
              if (zoom_mode !== "") {
                $("button.zoom-in-button").removeClass("current-zoom");
                zoom_mode = "";
              }
              // now clear pan button
              if (pan_mode !== "") {
                $("button.pan-button").removeClass("current-zoom");
                pan_mode = "";
                options.pan.interactive = false;
              }
              // now set roiset mode
              if (roi2set !== "") {
                $("#roi" + roi2set).removeClass("current-roi");
                roi2set = "";
              }
              roi2set = param;
              options.selection.mode = "x";
              replot(options);
              $("#roi" + param).addClass("current-roi");
              $.notify("Select ROI #" + param + " region using mouse.", "info");
            }
          }
        }

        //
        //
        //
        function update_chart() {
          if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-1") {
            chart = $.plot("#mca-chart", [mca1_data], mca1_options);
          } else if (localStorage.getItem(MCPHA_SELECTED_TAB) === "mca-2") {
            chart = $.plot("#mca-chart", [mca2_data], mca2_options);
          } else if (localStorage.getItem(MCPHA_SELECTED_TAB) === "osc") {

          }
        }

        //
        //
        //
        function show_busy_indicator(show) {
          if (show) {
            $('body').removeClass('loaded');
          } else {
            $('body').addClass('loaded');
          }
        }

        function show_sidebar(show) {
          if (show) {
            $('#slide-menu').addClass('open-side-nav');
            $('#slide-body').addClass('open-body-nav');
          } else {
            $('#slide-menu').removeClass('open-side-nav');
            $('#slide-body').removeClass('open-body-nav');
          }
        }

        //
        // Toggle sidebar
        //
        function toggle_sidebar() {
          $('#slide-menu').toggleClass('open-side-nav');
          $('#slide-body').toggleClass('open-body-nav');

          // save sidebar open state
          if ($('#slide-menu').hasClass('open-side-nav')) {
            localStorage.setItem(MCPHA_SIDEBAR_OPEN, 'true');
          } else {
            localStorage.removeItem(MCPHA_SIDEBAR_OPEN);
          }
          // HACK to resize chart div
          setTimeout(function () {
            resize_chart_div();
          }, 120);
        }
        ;

        //
        // Select div contaijner based on tab selection
        //
        function select_tab(tab) {
          // save this as the current selected tab
          localStorage.setItem(MCPHA_SELECTED_TAB, tab);
          // hide unselected tabs and show selected tab
          if (tab === "mca-1" || tab === null) {
            // unhide sidebar
            $('#mca-1-sidebar').css('display', 'inline');
            $('#mca-2-sidebar').css('display', 'none');
            $('#osc-sidebar').css('display', 'none');
            $('#log-sidebar').css('display', 'none');
            // show relevant container
            $('#mca-toolbar').css('display', 'inline');
            $('#mca-container').css('display', 'inline');
            $('#osc-container').css('display', 'none');
            $('#log-container').css('display', 'none');
            // show tab selection bar
            $('#mca-1').addClass("selectedtab");
            $('#mca-2').removeClass("selectedtab");
            $('#osc').removeClass("selectedtab");
            $('#log').removeClass("selectedtab");
            // update cursor panel
            $("#acqtime_s").text(localStorage.getItem(MCPHA_MCA_1_ACQ_TIME));
          } else if (tab === "mca-2") {
            // unhide sidebar
            $('#mca-1-sidebar').css('display', 'none');
            $('#mca-2-sidebar').css('display', 'inline');
            $('#osc-sidebar').css('display', 'none');
            $('#log-sidebar').css('display', 'none');
            // show relevant container
            $('#mca-toolbar').css('display', 'inline');
            $('#mca-container').css('display', 'inline');
            $('#osc-container').css('display', 'none');
            $('#log-container').css('display', 'none');
            // show tab selection bar
            $('#mca-1').removeClass("selectedtab");
            $('#mca-2').addClass("selectedtab");
            $('#osc').removeClass("selectedtab");
            $('#log').removeClass("selectedtab");
            // update cursor panel
            $("#acqtime_s").text(localStorage.getItem(MCPHA_MCA_2_ACQ_TIME));
          } else if (tab === "osc") {
            // unhide sidebar
            $('#mca-1-sidebar').css('display', 'none');
            $('#mca-2-sidebar').css('display', 'none');
            $('#osc-sidebar').css('display', 'inline');
            $('#log-sidebar').css('display', 'none');
            // show relevant container
            $('#mca-toolbar').css('display', 'none');
            $('#mca-container').css('display', 'none');
            $('#osc-container').css('display', 'inline');
            $('#log-container').css('display', 'none');
            // show tab selection bar
            $('#mca-1').removeClass("selectedtab");
            $('#mca-2').removeClass("selectedtab");
            $('#osc').addClass("selectedtab");
            $('#log').removeClass("selectedtab");
          } else if (tab === "log") {
            // unhide sidebar
            $('#mca-1-sidebar').css('display', 'none');
            $('#mca-2-sidebar').css('display', 'none');
            $('#osc-sidebar').css('display', 'none');
            $('#log-sidebar').css('display', 'inline');
            // show relevant container
            $('#mca-toolbar').css('display', 'none');
            $('#mca-container').css('display', 'none');
            $('#osc-container').css('display', 'none');
            $('#log-container').css('display', 'inline');
            // show tab selection bar
            $('#mca-1').removeClass("selectedtab");
            $('#mca-2').removeClass("selectedtab");
            $('#osc').removeClass("selectedtab");
            $('#log').addClass("selectedtab");
          }
        }

        //
        // Enable/Disable toolbar button
        //
        function update_toolbar_buttons(enable) {
          var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
          if (tab === null || tab.startsWith("mca")) {
            if (enable) {
              $('#roi1').removeClass('disabled');
              $('#roi2').removeClass('disabled');
              $('#roi3').removeClass('disabled');
              $('#enableacq').removeClass('disabled');
              $('#cleartimer').removeClass('disabled');
              $('#cleardata').removeClass('disabled');
              $('#fullextent').removeClass('disabled');
              $('#zoomin').removeClass('disabled');
              $('#zoomout').removeClass('disabled');
              $('#pan').removeClass('disabled');
              $('#linscale').removeClass('disabled');
              $('#logscale').removeClass('disabled');
              $('#download').removeClass('disabled');
            } else {
              $('#roi1').addClass('disabled');
              $('#roi2').addClass('disabled');
              $('#roi3').addClass('disabled');
              $('#enableacq').addClass('disabled');
              $('#cleartimer').addClass('disabled');
              $('#cleardata').addClass('disabled');
              $('#fullextent').addClass('disabled');
              $('#zoomin').addClass('disabled');
              $('#zoomout').addClass('disabled');
              $('#pan').addClass('disabled');
              $('#linscale').addClass('disabled');
              $('#logscale').addClass('disabled');
              $('#download').addClass('disabled');
            }
          } else if (tab === "log") {
          } else if (tab === "osc") {
          }
        }

        //
        //
        //
        function update_mca_acquisition_buttons_text(active) {
          //$('#enableacq').text(mca ? "Stop" : "Start");
          $('#enableacq').html(active ? STOP_ACQUISITION_TEXT : START_ACQUISITION_TEXT);
        }
        
        //
        // Initialise sidebar
        //
        function init_sidebar() {
          // hide all sidebars
          $('#mca-1-sidebar').css('display', 'none');
          $('#mca-2-sidebar').css('display', 'none');
          $('#osc-sidebar').css('display', 'none');
          $('#log-sidebar').css('display', 'none');

          //
          // Install tab click handler to show/hide sidebar menu
          //
          $('#mca-1').on('click', function () {
            select_tab("mca-1");
          });
          $('#mca-2').on('click', function () {
            select_tab("mca-2");
          });
          $('#osc').on('click', function () {
            select_tab("osc");
          });
          $('#log').on('click', function () {
            select_tab("log");
          });

          // restore sidebar if it last was open
          var p = localStorage.getItem(MCPHA_SIDEBAR_OPEN);
          show_sidebar(p !== null);
        }

        //
        // log messages to screen and message log
        //
        function log_status_message(msg, onscreen) {
          if (onscreen !== 'undefined' && onscreen !== null && onscreen) {
            Materialize.toast(msg, TOAST_DELAY);
          }
          $("<p>" + msg + "</p>").appendTo('#messages');
        }

        //
        // install settings update handlers
        //
        function init_settings_handlers() {
          var s;
          // Device address
          $('#' + MCPHA_DEVICE_ADDR).on('input', function (e) {
            localStorage.setItem(MCPHA_DEVICE_ADDR, $('#' + MCPHA_DEVICE_ADDR).val());
          });
          s = localStorage.getItem(MCPHA_DEVICE_ADDR);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_DEVICE_ADDR).val(s);
          } else {
            localStorage.setItem(MCPHA_DEVICE_ADDR, $('#' + MCPHA_DEVICE_ADDR).val());
          }

          // Connect device
          $('#' + MCPHA_CONNECT_DEVICE).on('click', function (e) {
            var on = $('#' + MCPHA_CONNECT_DEVICE).prop('checked');
            localStorage.setItem(MCPHA_CONNECT_DEVICE, on ? "on" : "off");
            if (on) {
              wsock = init_websocket(wsock);
            } else {
              if (wsock !== null && wsock.readyState === 1) {
                wsock.close();
              }
              wsock = null;
            }
          });
          s = localStorage.getItem(MCPHA_CONNECT_DEVICE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_CONNECT_DEVICE).prop('checked', s === "on");
          } else {
            localStorage.setItem(MCPHA_CONNECT_DEVICE, $('#' + MCPHA_CONNECT_DEVICE).prop('checked') ? "on" : "off");
          }

          // Decimation factor (between 4 and 8192)
          $('#' + MCPHA_DEC_FACTOR).on('input', function (e) {
            // TODO: ensure number is between 4 and 8192 in increments of 4
            localStorage.setItem(MCPHA_DEC_FACTOR, $('#' + MCPHA_DEC_FACTOR).val());
          });
          s = localStorage.getItem(MCPHA_DEC_FACTOR);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_DEC_FACTOR).val(s);
          } else {
            localStorage.setItem(MCPHA_DEC_FACTOR, $('#' + MCPHA_DEC_FACTOR).val());
          }

          // MCA LLD
          $('#' + MCPHA_MCA_LLD).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_LLD, $('#' + MCPHA_MCA_LLD).val());
          });
          s = localStorage.getItem(MCPHA_MCA_LLD);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_LLD).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_LLD, $('#' + MCPHA_MCA_LLD).val());
          }

          // MCA ULD
          $('#' + MCPHA_MCA_ULD).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_ULD, $('#' + MCPHA_MCA_ULD).val());
          });
          s = localStorage.getItem(MCPHA_MCA_ULD);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_ULD).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_ULD, $('#' + MCPHA_MCA_ULD).val());
          }

          // MCA data format
          $('#' + MCPHA_MCA_DATA_FORMAT).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_DATA_FORMAT, $('#' + MCPHA_MCA_DATA_FORMAT).val());
          });
          s = localStorage.getItem(MCPHA_MCA_DATA_FORMAT);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_DATA_FORMAT).val(s);
            $('#' + MCPHA_MCA_DATA_FORMAT).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_DATA_FORMAT, $('#' + MCPHA_MCA_DATA_FORMAT).val());
          }

          // MCA 1 input negative
          $('#' + MCPHA_MCA_1_IN_NEG).on('click', function (e) {
            localStorage.setItem(MCPHA_MCA_1_IN_NEG, $('#' + MCPHA_MCA_1_IN_NEG).prop('checked') ? "true" : "false");
          });
          s = localStorage.getItem(MCPHA_MCA_1_IN_NEG);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_IN_NEG).prop('checked', s === "true");
          } else {
            localStorage.setItem(MCPHA_MCA_1_IN_NEG, $('#' + MCPHA_MCA_1_IN_NEG).prop('checked') ? "true" : "false");
          }

          // MCA 1 acquisition time (seconds)
          $('#' + MCPHA_MCA_1_ACQ_TIME).on('input', function (e) {
            localStorage.setItem(MCPHA_MCA_1_ACQ_TIME, $('#' + MCPHA_MCA_1_ACQ_TIME).val());
            $("#acqtime_s").text($('#' + MCPHA_MCA_1_ACQ_TIME).val());
          });
          s = localStorage.getItem(MCPHA_MCA_1_ACQ_TIME);
          console.log("->"+s);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_ACQ_TIME).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_1_ACQ_TIME, $('#' + MCPHA_MCA_1_ACQ_TIME).val());
          }

          // MCA 1 trigger mode (normal or automatic)
          $('#' + MCPHA_MCA_1_TRIG_MODE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_1_TRIG_MODE, $('#' + MCPHA_MCA_1_TRIG_MODE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_1_TRIG_MODE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_TRIG_MODE).val(s);
            $('#' + MCPHA_MCA_1_TRIG_MODE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_1_TRIG_MODE, $('#' + MCPHA_MCA_1_TRIG_MODE).val());
          }

          // MCA 1 trigger source (channel 1 or channel 2)
          $('#' + MCPHA_MCA_1_TRIG_SOURCE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_1_TRIG_SOURCE, $('#' + MCPHA_MCA_1_TRIG_SOURCE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_1_TRIG_SOURCE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_TRIG_SOURCE).val(s);
            $('#' + MCPHA_MCA_1_TRIG_SOURCE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_1_TRIG_SOURCE, $('#' + MCPHA_MCA_1_TRIG_SOURCE).val());
          }

          // MCA 1 trigger edge (rising or falling)
          $('#' + MCPHA_MCA_1_TRIG_EDGE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_1_TRIG_EDGE, $('#' + MCPHA_MCA_1_TRIG_EDGE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_1_TRIG_EDGE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_TRIG_EDGE).val(s);
            $('#' + MCPHA_MCA_1_TRIG_EDGE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_1_TRIG_EDGE, $('#' + MCPHA_MCA_1_TRIG_EDGE).val());
          }

          // MCA 1 Trigger level
          $('#' + MCPHA_MCA_1_TRIG_LEVEL).on('input', function (e) {
            localStorage.setItem(MCPHA_MCA_1_TRIG_LEVEL, $('#' + MCPHA_MCA_1_TRIG_LEVEL).val());
          });
          s = localStorage.getItem(MCPHA_MCA_1_TRIG_LEVEL);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_1_TRIG_LEVEL).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_1_TRIG_LEVEL, $('#' + MCPHA_MCA_1_TRIG_LEVEL).val());
          }

          // MCA 2 input negative
          $('#' + MCPHA_MCA_2_IN_NEG).on('click', function (e) {
            localStorage.setItem(MCPHA_MCA_2_IN_NEG, $('#' + MCPHA_MCA_2_IN_NEG).prop('checked') ? "true" : "false");
          });
          s = localStorage.getItem(MCPHA_MCA_2_IN_NEG);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_IN_NEG).prop('checked', s === "true");
          } else {
            localStorage.setItem(MCPHA_MCA_2_IN_NEG, $('#' + MCPHA_MCA_2_IN_NEG).prop('checked') ? "true" : "false");
          }

          // MCA 2 acquisition time (seconds)
          $('#' + MCPHA_MCA_2_ACQ_TIME).on('input', function (e) {
            localStorage.setItem(MCPHA_MCA_2_ACQ_TIME, $('#' + MCPHA_MCA_2_ACQ_TIME).val());
            $("#acqtime_s").text($('#' + MCPHA_MCA_2_ACQ_TIME).val());
          });
          s = localStorage.getItem(MCPHA_MCA_2_ACQ_TIME);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_ACQ_TIME).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_2_ACQ_TIME, $('#' + MCPHA_MCA_2_ACQ_TIME).val());
          }

          // MCA 2 trigger mode (normal or automatic)
          $('#' + MCPHA_MCA_2_TRIG_MODE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_2_TRIG_MODE, $('#' + MCPHA_MCA_2_TRIG_MODE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_2_TRIG_MODE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_TRIG_MODE).val(s);
            $('#' + MCPHA_MCA_2_TRIG_MODE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_2_TRIG_MODE, $('#' + MCPHA_MCA_2_TRIG_MODE).val());
          }

          // MCA 2 trigger source (channel 1 or channel 2)
          $('#' + MCPHA_MCA_2_TRIG_SOURCE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_2_TRIG_SOURCE, $('#' + MCPHA_MCA_2_TRIG_SOURCE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_2_TRIG_SOURCE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_TRIG_SOURCE).val(s);
            $('#' + MCPHA_MCA_2_TRIG_SOURCE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_2_TRIG_SOURCE, $('#' + MCPHA_MCA_2_TRIG_SOURCE).val());
          }

          // MCA 2 trigger edge (rising or falling)
          $('#' + MCPHA_MCA_2_TRIG_EDGE).on('change', function (e) {
            localStorage.setItem(MCPHA_MCA_2_TRIG_EDGE, $('#' + MCPHA_MCA_2_TRIG_EDGE).val());
          });
          s = localStorage.getItem(MCPHA_MCA_2_TRIG_EDGE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_TRIG_EDGE).val(s);
            $('#' + MCPHA_MCA_2_TRIG_EDGE).material_select();
          } else {
            localStorage.setItem(MCPHA_MCA_2_TRIG_EDGE, $('#' + MCPHA_MCA_2_TRIG_EDGE).val());
          }

          // MCA 2 Trigger level
          $('#' + MCPHA_MCA_2_TRIG_LEVEL).on('input', function (e) {
            localStorage.setItem(MCPHA_MCA_2_TRIG_LEVEL, $('#' + MCPHA_MCA_2_TRIG_LEVEL).val());
          });
          s = localStorage.getItem(MCPHA_MCA_2_TRIG_LEVEL);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_MCA_2_TRIG_LEVEL).val(s);
          } else {
            localStorage.setItem(MCPHA_MCA_2_TRIG_LEVEL, $('#' + MCPHA_MCA_2_TRIG_LEVEL).val());
          }

          // Oscilloscope channel 1 input
          $('#' + MCPHA_OSC_1_IN).on('click', function (e) {
            localStorage.setItem(MCPHA_OSC_1_IN, $('#' + MCPHA_OSC_1_IN).prop('checked') ? "true" : "false");
          });
          s = localStorage.getItem(MCPHA_OSC_1_IN);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_1_IN).prop('checked', s === "true");
          } else {
            localStorage.setItem(MCPHA_OSC_1_IN, $('#' + MCPHA_OSC_1_IN).prop('checked') ? "true" : "false");
          }

          // Oscilloscope channel 1 input negative
          $('#' + MCPHA_OSC_1_IN_NEG).on('click', function (e) {
            localStorage.setItem(MCPHA_OSC_1_IN_NEG, $('#' + MCPHA_OSC_1_IN_NEG).prop('checked') ? "true" : "false");
          });
          s = localStorage.getItem(MCPHA_OSC_1_IN_NEG);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_1_IN_NEG).prop('checked', s === "true");
          } else {
            localStorage.setItem(MCPHA_OSC_1_IN_NEG, $('#' + MCPHA_OSC_1_IN_NEG).prop('checked') ? "true" : "false");
          }

          // Oscilloscope channel 2 input
          $('#' + MCPHA_OSC_2_IN).on('click', function (e) {
            localStorage.setItem(MCPHA_OSC_2_IN, $('#' + MCPHA_OSC_2_IN).prop('checked') ? "true" : "false");
          });
          s = localStorage.getItem(MCPHA_OSC_2_IN);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_2_IN).prop('checked', s === "true");
          } else {
            localStorage.setItem(MCPHA_OSC_2_IN, $('#' + MCPHA_OSC_2_IN).prop('checked') ? "true" : "false");
          }

          // Oscilloscope channel 2 input negative
          $('#' + MCPHA_OSC_2_IN_NEG).on('click', function (e) {
            localStorage.setItem(MCPHA_OSC_2_IN_NEG, $('#' + MCPHA_OSC_2_IN_NEG).prop('checked') ? "true" : "false");
          });
          s = localStorage.getItem(MCPHA_OSC_2_IN_NEG);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_2_IN_NEG).prop('checked', s === "true");
          } else {
            localStorage.setItem(MCPHA_OSC_2_IN_NEG, $('#' + MCPHA_OSC_2_IN_NEG).prop('checked') ? "true" : "false");
          }

          // Oscilloscope trigger mode (normal or automatic)
          $('#' + MCPHA_OSC_TRIG_MODE).on('change', function (e) {
            localStorage.setItem(MCPHA_OSC_TRIG_MODE, $('#' + MCPHA_OSC_TRIG_MODE).val());
          });
          s = localStorage.getItem(MCPHA_OSC_TRIG_MODE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_TRIG_MODE).val(s);
            $('#' + MCPHA_OSC_TRIG_MODE).material_select();
          } else {
            localStorage.setItem(MCPHA_OSC_TRIG_MODE, $('#' + MCPHA_OSC_TRIG_MODE).val());
          }

          // Oscilloscope trigger source (channel 1 or channel 2)
          $('#' + MCPHA_OSC_TRIG_SOURCE).on('change', function (e) {
            localStorage.setItem(MCPHA_OSC_TRIG_SOURCE, $('#' + MCPHA_OSC_TRIG_SOURCE).val());
          });
          s = localStorage.getItem(MCPHA_OSC_TRIG_SOURCE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_TRIG_SOURCE).val(s);
            $('#' + MCPHA_OSC_TRIG_SOURCE).material_select();
          } else {
            localStorage.setItem(MCPHA_OSC_TRIG_SOURCE, $('#' + MCPHA_OSC_TRIG_SOURCE).val());
          }

          // Oscilloscope trigger edge (rising or falling)
          $('#' + MCPHA_OSC_TRIG_EDGE).on('change', function (e) {
            localStorage.setItem(MCPHA_OSC_TRIG_EDGE, $('#' + MCPHA_OSC_TRIG_EDGE).val());
          });
          s = localStorage.getItem(MCPHA_OSC_TRIG_EDGE);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_TRIG_EDGE).val(s);
            $('#' + MCPHA_OSC_TRIG_EDGE).material_select();
          } else {
            localStorage.setItem(MCPHA_OSC_TRIG_EDGE, $('#' + MCPHA_OSC_TRIG_EDGE).val());
          }

          // Oscilloscope trigger level
          $('#' + MCPHA_OSC_TRIG_LEVEL).on('input', function (e) {
            localStorage.setItem(MCPHA_OSC_TRIG_LEVEL, $('#' + MCPHA_OSC_TRIG_LEVEL).val());
          });
          s = localStorage.getItem(MCPHA_OSC_TRIG_LEVEL);
          if (s !== null && s !== 'undefined') {
            $('#' + MCPHA_OSC_TRIG_LEVEL).val(s);
          } else {
            localStorage.setItem(MCPHA_OSC_TRIG_LEVEL, $('#' + MCPHA_OSC_TRIG_LEVEL).val());
          }
        }

        //
        //
        //
        function init_tool_handlers() {
          $('#enableacq').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === "mca-1") {
              if (mca1_acq) {
                // Stop acquisition
                mcpha_send(MCPHA_COMMAND_SET_TIMER_MODE, 0, 0);
                // stop update request timer
                clearInterval(mca1_timer);
              } else {
                // Start acquisition
                mcpha_send(MCPHA_COMMAND_SET_PHA_MIN_THRESHOLD, 0, parseInt(localStorage.getItem(MCPHA_MCA_LLD)));
                mcpha_send(MCPHA_COMMAND_SET_PHA_MAX_THRESHOLD, 0, parseInt(localStorage.getItem(MCPHA_MCA_ULD)));
                // set whether mca channel 1 has negative input
                mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE, 0, localStorage.getItem(MCPHA_MCA_1_IN_NEG) === " true" ? 1 : 0);
                  // set acquisitgion time
                mca1_acqtime = parseInt(localStorage.getItem(MCPHA_MCA_1_ACQ_TIME)) * TIMER_FREQ;
                mcpha_send(MCPHA_COMMAND_SET_TIMER_VALUE, 0, mca1_acqtime);
                // set timer mode
                mcpha_send(MCPHA_COMMAND_SET_TIMER_MODE, 0, 1);
                // activate timer to request periodic updates
                if (mca1_timer !== null) {
                  clearInterval(mca1_timer);
                }
                mca1_timer = setInterval(function () {
                  // request timer value
                  mcpha_send(MCPHA_COMMAND_GET_TIMER, 0, 0);
                  // request histogram data
                  mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA, 0, 0);
                }, 1000);
              }
              // toggle acquisition flag and update acquisition button text
              mca1_acq = !mca1_acq;
              update_mca_acquisition_buttons_text(mca1_acq);
            } else if (tab === "mca-2") {
              if (mca2_acq) {
                // Stop acquisition
                mcpha_send(MCPHA_COMMAND_SET_TIMER_MODE, 1, 0);
                // stop update request timer
                clearInterval(mca2_timer);
              } else {
                // Start acquisition
                mcpha_send(MCPHA_COMMAND_SET_PHA_MIN_THRESHOLD, 1, parseInt(localStorage.getItem(MCPHA_MCA_LLD)));
                mcpha_send(MCPHA_COMMAND_SET_PHA_MAX_THRESHOLD, 1, parseInt(localStorage.getItem(MCPHA_MCA_ULD)));
                // set whether mca channel 1 has negative input
                mcpha_send(MCPHA_COMMAND_SET_NEGATOR_MODE, 1, localStorage.getItem(MCPHA_MCA_2_IN_NEG) === " true" ? 1 : 0);
                // set acquisitgion time
                mca2_acqtime = parseInt(localStorage.getItem(MCPHA_MCA_2_ACQ_TIME)) * TIMER_FREQ;
                mcpha_send(MCPHA_COMMAND_SET_TIMER_VALUE, 1, mca2_acqtime);
                // set timer mode
                mcpha_send(MCPHA_COMMAND_SET_TIMER_MODE, 1, 1);
                // activate timer to request periodic updates
                if (mca2_timer !== null) {
                  clearInterval(mca2_timer);
                }
                mca2_timer = setInterval(function () {
                  // request timer value
                  mcpha_send(MCPHA_COMMAND_GET_TIMER, 1, 0);
                  // request histogram data
                  mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA, 1, 0);
                }, 1000);
              }
              // toggle acquisition flag and update acquisition button text
              mca2_acq = !mca2_acq;
              update_mca_acquisition_buttons_text(mca2_acq);
            }
          });

          $('#cleartimer').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === "mca-1") {
              // Reset timer
              mcpha_send(MCPHA_COMMAND_RESET_TIMER, 0, 0);
              // request timer value
              mcpha_send(MCPHA_COMMAND_GET_TIMER, 0, 0);
            } else if (tab === "mca-2") {
              // Reset timer
              mcpha_send(MCPHA_COMMAND_RESET_TIMER, 1, 0);
              // request timer value
              mcpha_send(MCPHA_COMMAND_GET_TIMER, 1, 0);
            }
          });

          $('#cleardata').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            var ch = (tab === "mca-1") ? 0 : (tab === "mca-2") ? 1 : -1;
            if (ch !== -1) {
              // Reset histogram
              mcpha_send(MCPHA_COMMAND_RESET_HISTOGRAM, ch, 0);
              // Reset timer
              mcpha_send(MCPHA_COMMAND_RESET_TIMER, ch, 0);
              // request timer value
              mcpha_send(MCPHA_COMMAND_GET_TIMER, ch, 0);
              // request histogram
              mcpha_send(MCPHA_COMMAND_GET_HISTOGRAM_DATA, ch, 0);
            }
          });

          $('#download').on('click', function (e) {
            var file = null;
            var data = null;
            var format = localStorage.getItem(MCPHA_MCA_DATA_FORMAT);
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === 'mca-1') {
              if (format === "ortec-chn") {
                data = "data:application/octet-stream;base64," + uint_8_to_base_64(new Uint8Array([65, 66, 67, 68]));
              } else if (format === "json-txt") {
                data = "data:text/plain,{'x':1234}";
              }
              file = "mca1-data.gif";
            } else if (tab === 'mca-2') {
              if (format === "ortec-chn") {
                data = "data:application/octet-stream;base64," + uint_8_to_base_64(new Uint8Array([65, 66, 67, 68]));
              } else if (format === "json-txt") {
                data = data = "data:text/plain,{'x':1234}";
              }
              file = "mca2-data.gif";
            }
            if (file !== null) {
              download(data, file);
            }
          });

          // zoom IN button
          $('#zoomin').on('click', function (e) {
            set_cursor_mode(CURSOR_MODE_ZOOMIN);
          });

          // zoom OUT button
          $('#zoomout').on('click', function (e) {
            set_cursor_mode(CURSOR_MODE_ZOOMOUT);
          });

          // zoom to see all channels
          $("#fullextent").click(function () {
            var axis = chart.getAxes();
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (tab === 'mca-1') {
              mca1_options.xaxis.min = axis.xaxis.datamin;
              mca1_options.xaxis.max = Math.ceil(axis.xaxis.datamax);
              mca1_options.yaxis.min = 0;
              mca1_options.yaxis.max = Math.ceil(axis.yaxis.datamax);
              mca1_options.xaxis.tickSize = get_zoom_ticks(mca1_options.xaxis.min, mca1_options.xaxis.max, mca1_options);
              update_chart();
              set_cursor_mode(CURSOR_MODE_CLEAR_ALL);
            } else if (tab === 'mca-2') {
              mca2_options.xaxis.min = axis.xaxis.datamin;
              mca2_options.xaxis.max = Math.ceil(axis.xaxis.datamax);
              mca2_options.yaxis.min = 0;
              mca2_options.yaxis.max = Math.ceil(axis.yaxis.datamax);
              mca2_options.xaxis.tickSize = get_zoom_ticks(mca2_options.xaxis.min, mca2_options.xaxis.max, mca2_options);
              update_chart();
              set_cursor_mode(CURSOR_MODE_CLEAR_ALL);
            }
          });

          // ROI 1 button
          $('#roi1').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (set_cursor_mode(CURSOR_MODE_SETROI_1) === CURSOR_MODE_SETROI_1) {
              if (tab === 'mca-1') {
                mca1_options.selection.mode = "x";
              } else if (tab === 'mca-2') {
                mca2_options.selection.mode = "x";
              }
              update_chart();
            }
          });

          // ROI 2 button
          $('#roi2').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (set_cursor_mode(CURSOR_MODE_SETROI_2) === CURSOR_MODE_SETROI_2) {
              if (tab === 'mca-1') {
                mca1_options.selection.mode = "x";
              } else if (tab === 'mca-2') {
                mca2_options.selection.mode = "x";
              }
              update_chart();
            }
          });

          // ROI 3 button
          $('#roi3').on('click', function (e) {
            var tab = localStorage.getItem(MCPHA_SELECTED_TAB);
            if (set_cursor_mode(CURSOR_MODE_SETROI_3) === CURSOR_MODE_SETROI_3) {
              if (tab === 'mca-1') {
                mca1_options.selection.mode = "x";
              } else if (tab === 'mca-2') {
                mca2_options.selection.mode = "x";
              }
              update_chart();
            }
          });
        }

        //
        function init_tabs() {
          select_tab(localStorage.getItem(MCPHA_SELECTED_TAB));
        }

        //
        //
        //
        function init_keypress_handlers() {
          // Catch keypressess
          // left = 37, up = 38, right = 39, down = 40
          $(document).keyup(function (e) {
            if (e.which === 37) {
              console.log("****YOU PRESSED LEFT****");
            } else if (e.which === 38) {
              adjust_vertical_scale_and_update(+1);
            } else if (e.which === 39) {
              console.log("****YOU PRESSED RIGHT****");
            } else if (e.which === 40) {
              adjust_vertical_scale_and_update(-1);
            } else if (e.which === 13) {
              console.log("****YOU PRESSED ENTER****");
            }
          });
        }

        // initialise device connection status indicator
        update_device_connection_indicator(WEBSOCKET_DISCONNECTED);

        // install settings update handlers
        init_settings_handlers();

        // install tool handlers
        init_tool_handlers();

        // init chart handlers
        init_chart_handlers();

        // install keypress handlers
        init_keypress_handlers();

        //
        // Install sidebar menu click handler to show/hide sidebar menu
        //
        $('#sidebar').on('click', function () {
          toggle_sidebar();
        });

        $('select').material_select();

        // initialise sidebar
        init_sidebar();

        // initialise tabs
        init_tabs();

        // hide busy indicator
        show_busy_indicator(false);

        // if device connection button is on then
        // try and establish a connection now.
        if ($('#' + MCPHA_CONNECT_DEVICE).prop('checked')) {
          wsock = init_websocket(wsock);
        }

        mca1_options = default_mca_chart_options();

        mca2_options = default_mca_chart_options();

        chart = $.plot("#mca-chart", [[0, 0], [16384, 0]], mca1_options);

        // install browser window resize handler
        window.addEventListener('resize', resize_handler);
        // resize chart to fit browser window
        resize_chart_div();

        // ok ready now
        log_status_message("Ready", true);
      });
    </script>

    <!-- Start of busy indicator section -->
    <div id="loader-wrapper">
      <div id="loader"></div>
      <div class="loader-section section-left"></div>
      <div class="loader-section section-right"></div>
    </div>
    <!-- End of busy indicator section -->

    <header>
      <nav>
        <div class="nav-wrapper brown darken-2">
          <a id="sidebar" href="#"><i class="left large material-icons">menu</i></a>
          <div class="center brand-logo">MCPHA Client</div>
          <ul class="right hide-on-med-and-down">
            <li><a  id="mca-1" class="waves-effect waves-light btn orange lighten-4 selectedtab">MCA 1</a></li>
            <li><a id="mca-2" class="waves-effect waves-light btn orange lighten-4">MCA 2</a></li>
            <li><a id="osc" class="waves-effect waves-light btn orange lighten-4">Oscilloscope</a></li>
            <li><a id="log" class="waves-effect waves-light btn orange lighten-4">Log</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <main>
      <div class="root-container">
        <div id="slide-menu" class="side-nav">
          <h5>General Settings</h5>
          <form>
            <div class="valign-wrapper">
              <div class="s6 input-field">
                <label>Device IP Address</label>
                <input type="text" id="mcpha_device_addr" value="0.0.0.0">
              </div>
              <div class="switch s6">
                <label class="right valign">
                  <input type="checkbox" id="mcpha_connect_device">
                  <span class="lever"></span>
                </label>
              </div>
            </div>
            <div class="valign-wrapper">
              <div class="s6 input-field">
                <label>LLD</label>
                <input type="text" id="mcpha_mca_lld" value="300">
              </div>
              <div class="s6 input-field right">
                <label>ULD</label>
                <input type="text" id="mcpha_mca_uld" value="16300">
              </div>
            </div>
            <div class="input-field">
              <select id="mcpha_mca_data_format">
                <option selected value="json-txt">Text File</option>
                <option value="ortec-chn">Ortec Maestro Chn</option>
              </select>
              <label>MCA Data Format</label>
            </div>
            <div class="input-field">
              <label>Decimation Factor</label>
              <input type="number" step="4" id="mcpha_dec_factor" value="4">
            </div>
          </form>
          <div id="mca-1-sidebar">
            <h5>MCA 1 Settings</h5>
            <form action="#">
              <div class="switch">
                <label class="left">Negative Input</label>
                <label class="right">
                  <input type="checkbox" id="mcpha_mca_1_in_neg" checked="checked">
                  <span class="lever"></span>
                </label>
              </div>
              <br/>
              <div class="input-field">
                <label>Acquisition Time (seconds)</label>
                <input type="number" step="1" id="mcpha_mca_1_acq_time" value="60">
              </div>
              <div class="input-field">
                <select id="mcpha_mca_1_trig_mode">
                  <option selected value="n">Normal</option>
                  <option value="a">Automatic</option>
                </select>
                <label>Trigger Mode</label>
              </div>
              <div class="input-field">
                <select id="mcpha_mca_1_trig_source">
                  <option selected value="1">Channel 1</option>
                  <option value="2">Channel 2</option>
                </select>
                <label>Trigger Source</label>
              </div>
              <div class="input-field">
                <select id="mcpha_mca_1_trig_edge">
                  <option selected value="r">Rising  _/¯</option>
                  <option value="f">Falling  ¯\_</option>
                </select>
                <label>Trigger Edge</label>
              </div>
              <div class="input-field">
                <label>Trigger Level</label>
                <input type="number" id="mcpha_mca_1_trig_level" step="5" value="200">
              </div>
            </form>
          </div>
          <div id="mca-2-sidebar">
            <h5>MCA 2 Settings</h5>
            <form action="#">
              <div class="switch">
                <label class="left">Negative Input</label>
                <label class="right">
                  <input type="checkbox" id="mcpha_mca_2_in_neg" checked="checked">
                  <span class="lever"></span>
                </label>
              </div>
              <br/>
              <div class="input-field">
                <label>Acquisition Time (seconds)</label>
                <input type="number" step="1" id="mcpha_mca_2_acq_time" value="60">
              </div>
              <div class="input-field">
                <select id="mcpha_mca_2_trig_mode">
                  <option selected value="n">Normal</option>
                  <option value="a">Automatic</option>
                </select>
                <label>Trigger Mode</label>
              </div>
              <div class="input-field">
                <select id="mcpha_mca_2_trig_source">
                  <option value="1">Channel 1</option>
                  <option selected value="2">Channel 2</option>
                </select>
                <label>Trigger Source</label>
              </div>
              <div class="input-field">
                <select id="mcpha_mca_2_trig_edge">
                  <option selected value="r">Rising  _/¯</option>
                  <option value="f">Falling  ¯\_</option>
                </select>
                <label>Trigger Edge</label>
              </div>
              <div class="input-field">
                <label>Trigger Level</label>
                <input type="number" id="mcpha_mca_2_trig_level" step="5" value="200">
              </div>
            </form>
          </div>
          <div id="osc-sidebar">
            <h5>Oscilloscope Settings</h5>
            <form action="#">
              <div class="switch switch-row-spacing">
                <label class="left">Channel 1</label>
                <label class="right">
                  <input type="checkbox" id="mcpha_osc_1_in" checked="checked">
                  <span class="lever"></span>
                </label>
              </div>
              <br/>
              <div class="switch">
                <label class="left">Channel 1 Negative Input</label>
                <label class="right">
                  <input type="checkbox" id="mcpha_osc_1_in_neg" checked="checked">
                  <span class="lever"></span>
                </label>
              </div>
              <br/><br/>
              <div class="switch switch-row-spacing">
                <label class="left">Channel 2</label>
                <label class="right">
                  <input type="checkbox" id="mcpha_osc_2_in" checked="checked">
                  <span class="lever"></span>
                </label>
              </div>
              <br/>
              <div class="switch">
                <label class="left">Channel 2 Negative Input</label>
                <label class="right">
                  <input type="checkbox" id="mcpha_osc_2_in_neg" checked="checked">
                  <span class="lever"></span>
                </label>
              </div>
              <br/><br/>
              <div class="input-field">
                <select id="mcpha_osc_trig_mode">
                  <option selected value="n">Normal</option>
                  <option value="a">Automatic</option>
                </select>
                <label>Trigger Mode</label>
              </div>
              <div class="input-field">
                <select id="mcpha_osc_trig_source">
                  <option selected value="1">Channel 1</option>
                  <option value="2">Channel 2</option>
                </select>
                <label>Trigger Source</label>
              </div>
              <div class="input-field">
                <select id="mcpha_osc_trig_edge">
                  <option selected value="r">Rising  _/¯</option>
                  <option value="f">Falling  ¯\_</option>
                </select>
                <label>Trigger Edge</label>
              </div>
              <div class="input-field">
                <label>Trigger Level</label>
                <input type="number" id="mcpha_osc_trig_level" step="5" value="200">
              </div>
            </form>
          </div>
          <div id="log-sidebar">
            <h5>Log Settings</h5>
            <form action="#">
            </form>
          </div>
        </div>
        <div id="slide-body" class="side-body">
          <nav class="gray spacer10 no-shadow">
            <div id="mca-toolbar">
              <div class="left">
                  <a id="enableacq" class="btn waves-effect waves-light orange lighten-4 disabled" title="Set/Stop data acquisition"><i style="line-height:inherit" class="material-icons right">play_arrow</i>Start</a>
                <a id="cleartimer" class="waves-effect waves-light btn icon-btn orange lighten-4 disabled" title="Clear acquisition time"><i style="line-height:inherit" class="material-icons center">restore</i></a>
                <a id="cleardata" class="waves-effect waves-light btn icon-btn orange lighten-4 disabled" title="Clear acquisition data and time"><i style="line-height:inherit" class="material-icons center">delete</i></a>
              </div>
              <div class="right">
                  <a id="roi1" class="btn waves-effect waves-light orange lighten-4 disabled" title="Set ROI #1"><i style="line-height:inherit" class="material-icons right">looks_one</i>ROI</a>
                  <a id="roi2" class="btn waves-effect waves-light orange lighten-4 disabled" title="Set ROI #2"><i style="line-height:inherit" class="material-icons right">looks_two</i>ROI</a>
                  <a id="roi3" class="btn waves-effect waves-light orange lighten-4 disabled" title="Set ROI #3"><i style="line-height:inherit" class="material-icons right">looks_3</i>ROI</a>
                  <div style="width: 10px; display:inline-block"></div>
                  <a id="fullextent" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Full extent"><i style="line-height:inherit" class="material-icons center">aspect_ratio</i></a>
                  <a id="zoomin" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Full extent"><i style="line-height:inherit" class="material-icons">zoom_in</i></a>
                  <a id="zoomout" class="btn icon-btn  waves-effect waves-light orange lighten-4 disabled" title="Full extent"><i style="line-height:inherit" class="material-icons">zoom_out</i></a>
                  <a id="pan" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Full extent"><i style="line-height:inherit" class="material-icons">pan_tool</i></a>
                  <div style="width: 10px; display:inline-block"></div>
                  <a id="linscale" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Log scale">Lin</a>
                  <a id="logscale" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Linear scale">Log</a>
                  <div style="width: 10px; display:inline-block"></div>
                  <a id="download" class="btn icon-btn waves-effect waves-light orange lighten-4 disabled" title="Download data"><i  style="line-height:inherit" class="material-icons">file_download</i></a>
              </div>
            </div>
          </nav>
          <div id="mca-container">
            <div id="cursor-panel">
              Cursor ......... : <span id="cursor">0</span>
              Counts ......... : <span id="counts">0</span>
              Acq. Time (s) .. : <span id="acqtime_s"></span>
              Elapsed Time (s) : <span id="elapsedtime"></span>
              ROI #1 ......... : <span id="roi1_counts"></span>
              ROI #2 ......... : <span id="roi2_counts"></span>
              ROI #3 ......... : <span id="roi3_counts"></span>
            </div>
            <div id="mca-chart"></div>
          </div>
          <div id="osc-container">
            OSCILLOSCOPE
          </div>
          <div id="log-container">
            <div id="messages">

            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="page-footer brown darken-2">
      <div>
        <div class="right">
          <div class="net-traffic" title="Network traffic."><i class="small material-icons">swap_horiz</i></div>
          <div class="device-connection"><i id="device-connection" class="small material-icons">signal_cellular_null</i></div>
        </div>
      </div>
    </footer>
  </body>
</html>